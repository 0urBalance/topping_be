<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>회원가입 - Topping</title>
    <link rel="stylesheet" th:href="@{/css/navbar.css}">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: Arial, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; }
        .main-content { display: flex; align-items: center; justify-content: center; min-height: calc(100vh - 70px); padding: 20px; }
        .signup-container { background: white; border-radius: 10px; box-shadow: 0 15px 35px rgba(0,0,0,0.1); padding: 40px; width: 100%; max-width: 450px; }
        .logo { text-align: center; margin-bottom: 30px; }
        .logo h1 { color: #333; font-size: 32px; margin-bottom: 5px; }
        .logo p { color: #666; font-size: 14px; }
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; margin-bottom: 8px; color: #333; font-weight: bold; }
        .form-group input, .form-group select { width: 100%; padding: 12px 15px; border: 2px solid #e1e1e1; border-radius: 5px; font-size: 16px; transition: border-color 0.3s; }
        .form-group input:focus, .form-group select:focus { outline: none; border-color: #667eea; }
        .form-group.valid input { border-color: #27ae60; }
        .form-group.invalid input { border-color: #e74c3c; }
        .btn { width: 100%; padding: 12px; background: #667eea; color: white; border: none; border-radius: 5px; font-size: 16px; font-weight: bold; cursor: pointer; transition: background 0.3s; }
        .btn:hover { background: #5a6fd8; }
        .btn:disabled { background: #ccc; cursor: not-allowed; }
        .error-message { color: #e74c3c; font-size: 14px; margin-top: 5px; display: none; }
        .success-message { color: #27ae60; font-size: 14px; margin-top: 5px; display: none; }
        .valid-message { color: #27ae60; font-size: 14px; margin-top: 5px; display: none; }
        .links { text-align: center; margin-top: 20px; }
        .links a { color: #667eea; text-decoration: none; font-size: 14px; }
        .links a:hover { text-decoration: underline; }
        .loading { display: none; text-align: center; margin-top: 10px; }
        .spinner { display: inline-block; width: 20px; height: 20px; border: 3px solid #f3f3f3; border-top: 3px solid #667eea; border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .password-strength { margin-top: 5px; }
        .strength-bar { height: 4px; background: #e1e1e1; border-radius: 2px; overflow: hidden; }
        .strength-fill { height: 100%; transition: width 0.3s, background-color 0.3s; }
        .strength-weak { background: #e74c3c; }
        .strength-medium { background: #f39c12; }
        .strength-strong { background: #27ae60; }
        .strength-text { font-size: 12px; margin-top: 2px; }
        .checkbox-group { display: flex; align-items: flex-start; gap: 10px; }
        .checkbox-group input[type="checkbox"] { width: auto; margin-top: 3px; cursor: pointer; }
        .checkbox-label { flex: 1; font-size: 14px; line-height: 1.4; cursor: pointer; }
        .terms-link { color: #667eea; text-decoration: none; font-weight: bold; }
        .terms-link:hover { text-decoration: underline; }
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.4); }
        .modal-content { background-color: #fefefe; margin: 5% auto; padding: 20px; border: none; border-radius: 10px; width: 80%; max-width: 600px; max-height: 80vh; overflow-y: auto; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .modal-title { font-size: 20px; font-weight: bold; color: #333; }
        .close { color: #aaa; font-size: 28px; font-weight: bold; cursor: pointer; }
        .close:hover, .close:focus { color: #000; text-decoration: none; }
        .modal-body { line-height: 1.6; color: #333; }
        .modal-body h3 { margin-top: 20px; margin-bottom: 10px; color: #667eea; }
        .modal-body p { margin-bottom: 10px; }
        .modal-body ul { margin-bottom: 10px; padding-left: 20px; }
    </style>
</head>
<body>
    <!-- Include Navigation Bar -->
    <div th:replace="fragments/navbar :: navbar"></div>
    
    <div class="main-content">
        <div class="signup-container">
        <div class="logo">
            <h1>🍕 Topping</h1>
            <p>Collabo 플랫폼에 가입하세요</p>
        </div>

        <form id="signupForm" onsubmit="handleSignup(event)">
            <div class="form-group">
                <label for="name">이름</label>
                <input type="text" id="name" name="name" required placeholder="이름을 입력하세요" 
                       oninput="validateName()">
                <div class="error-message" id="nameError"></div>
                <div class="valid-message" id="nameValid"></div>
            </div>

            <div class="form-group">
                <label for="email">이메일</label>
                <input type="email" id="email" name="email" required placeholder="your@email.com" 
                       oninput="validateEmail()">
                <div class="error-message" id="emailError"></div>
                <div class="valid-message" id="emailValid"></div>
            </div>

            <div class="form-group">
                <label for="role">역할</label>
                <select id="role" name="role" required>
                    <option value="">역할을 선택하세요</option>
                    <option value="ROLE_USER">일반 사용자</option>
                    <option value="ROLE_BUSINESS_OWNER">비즈니스 오너</option>
                </select>
                <div class="error-message" id="roleError"></div>
            </div>

            <div class="form-group">
                <label for="password">비밀번호</label>
                <input type="password" id="password" name="password" required 
                       placeholder="6자 이상의 비밀번호" oninput="validatePassword()">
                <div class="password-strength" id="passwordStrength" style="display: none;">
                    <div class="strength-bar">
                        <div class="strength-fill" id="strengthFill"></div>
                    </div>
                    <div class="strength-text" id="strengthText"></div>
                </div>
                <div class="error-message" id="passwordError"></div>
                <div class="valid-message" id="passwordValid"></div>
            </div>

            <div class="form-group">
                <label for="confirmPassword">비밀번호 확인</label>
                <input type="password" id="confirmPassword" name="confirmPassword" required 
                       placeholder="비밀번호를 다시 입력하세요" oninput="validateConfirmPassword()">
                <div class="error-message" id="confirmPasswordError"></div>
                <div class="valid-message" id="confirmPasswordValid"></div>
            </div>

            <div class="form-group">
                <div class="checkbox-group">
                    <input type="checkbox" id="termsAgreement" name="termsAgreement" required>
                    <label for="termsAgreement" class="checkbox-label">
                        <a href="#" onclick="openTermsModal()" class="terms-link">이용약관</a> 및 
                        <a href="#" onclick="openPrivacyModal()" class="terms-link">개인정보처리방침</a>에 동의합니다.
                    </label>
                </div>
                <div class="error-message" id="termsError"></div>
            </div>

            <button type="submit" class="btn" id="signupBtn">
                회원가입
            </button>

            <div class="loading" id="loading">
                <div class="spinner"></div>
                <span>가입 처리 중...</span>
            </div>

            <div class="error-message" id="generalError"></div>
            <div class="success-message" id="successMessage"></div>
        </form>

        <div class="links">
            <a href="/auth/login">이미 계정이 있으신가요? 로그인</a>
        </div>
    </div>

    <!-- Terms of Service Modal -->
    <div id="termsModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">이용약관</h2>
                <span class="close" onclick="closeTermsModal()">&times;</span>
            </div>
            <div class="modal-body">
                <h3>제1조 (목적)</h3>
                <p>이 약관은 토핑(Topping) 플랫폼(이하 "서비스"라 함)의 이용조건 및 절차, 회사와 이용자 간의 권리, 의무 및 책임사항을 규정함을 목적으로 합니다.</p>
                
                <h3>제2조 (정의)</h3>
                <p>이 약관에서 사용하는 용어의 정의는 다음과 같습니다:</p>
                <ul>
                    <li>"서비스"라 함은 토핑 플랫폼에서 제공하는 모든 서비스를 의미합니다.</li>
                    <li>"회원"이라 함은 서비스에 개인정보를 제공하여 회원등록을 한 자를 의미합니다.</li>
                    <li>"콘텐츠"라 함은 서비스에서 제공되는 모든 정보, 데이터, 문서, 이미지 등을 의미합니다.</li>
                </ul>
                
                <h3>제3조 (약관의 효력 및 변경)</h3>
                <p>이 약관은 서비스 화면에 게시하여 공시함으로써 효력이 발생합니다. 회사는 합리적인 사유가 발생할 경우 이 약관을 변경할 수 있으며, 변경된 약관은 서비스 화면에 공지함으로써 효력이 발생합니다.</p>
                
                <h3>제4조 (서비스의 제공)</h3>
                <p>회사는 다음과 같은 서비스를 제공합니다:</p>
                <ul>
                    <li>비즈니스 협업 매칭 서비스</li>
                    <li>상품 및 서비스 등록 및 관리</li>
                    <li>협업 제안 및 소통 기능</li>
                    <li>기타 회사가 정하는 서비스</li>
                </ul>
                
                <h3>제5조 (회원의 의무)</h3>
                <p>회원은 다음 행위를 하여서는 안 됩니다:</p>
                <ul>
                    <li>허위 정보 입력</li>
                    <li>타인의 정보 도용</li>
                    <li>서비스 운영에 방해되는 행위</li>
                    <li>법령에 위반되는 행위</li>
                </ul>
                
                <h3>제6조 (개인정보보호)</h3>
                <p>회사는 관련 법령이 정하는 바에 따라 회원의 개인정보를 보호하기 위해 노력합니다. 개인정보의 보호 및 사용에 대해서는 관련 법령 및 개인정보처리방침을 따릅니다.</p>
            </div>
        </div>
    </div>

    <!-- Privacy Policy Modal -->
    <div id="privacyModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">개인정보처리방침</h2>
                <span class="close" onclick="closePrivacyModal()">&times;</span>
            </div>
            <div class="modal-body">
                <h3>1. 개인정보의 수집 및 이용목적</h3>
                <p>토핑 플랫폼은 다음의 목적을 위하여 개인정보를 처리합니다:</p>
                <ul>
                    <li>회원 가입 및 관리</li>
                    <li>서비스 제공 및 업무처리</li>
                    <li>마케팅 및 광고에의 활용</li>
                    <li>서비스 개선 및 신규 서비스 개발</li>
                </ul>
                
                <h3>2. 처리하는 개인정보 항목</h3>
                <p>토핑 플랫폼은 다음의 개인정보 항목을 처리하고 있습니다:</p>
                <ul>
                    <li>필수항목: 이름, 이메일, 비밀번호, 역할</li>
                    <li>선택항목: 프로필 사진, 전화번호, 주소</li>
                    <li>자동수집항목: 접속 IP, 접속 로그, 쿠키</li>
                </ul>
                
                <h3>3. 개인정보의 처리 및 보유기간</h3>
                <p>개인정보는 법령에 따른 개인정보 보유·이용기간 또는 정보주체로부터 개인정보를 수집 시에 동의받은 개인정보 보유·이용기간 내에서 처리·보유합니다.</p>
                
                <h3>4. 개인정보의 제3자 제공</h3>
                <p>토핑 플랫폼은 원칙적으로 정보주체의 개인정보를 제3자에게 제공하지 않습니다. 다만, 다음의 경우에는 예외로 합니다:</p>
                <ul>
                    <li>정보주체가 사전에 동의한 경우</li>
                    <li>법령의 규정에 의하거나, 수사 목적으로 법령에 정해진 절차와 방법에 따라 수사기관의 요구가 있는 경우</li>
                </ul>
                
                <h3>5. 개인정보 보호책임자</h3>
                <p>토핑 플랫폼은 개인정보 처리에 관한 업무를 총괄해서 책임지고, 개인정보 처리와 관련한 정보주체의 불만처리 및 피해구제 등을 위하여 개인정보 보호책임자를 지정하고 있습니다.</p>
                
                <h3>6. 정보주체의 권리·의무 및 그 행사방법</h3>
                <p>정보주체는 언제든지 개인정보 열람·정정·삭제·처리정지 요구 등의 권리를 행사할 수 있습니다.</p>
            </div>
        </div>
    </div>

    <script>
        // Check if user is already logged in
        if (localStorage.getItem('accessToken')) {
            window.location.href = '/mypage';
        }

        let validation = {
            name: false,
            email: false,
            password: false,
            confirmPassword: false,
            terms: false
        };

        async function handleSignup(event) {
            event.preventDefault();
            
            const formData = {
                name: document.getElementById('name').value,
                email: document.getElementById('email').value,
                role: document.getElementById('role').value,
                password: document.getElementById('password').value,
                confirmPassword: document.getElementById('confirmPassword').value,
                termsAgreement: document.getElementById('termsAgreement').checked
            };
            
            const signupBtn = document.getElementById('signupBtn');
            const loading = document.getElementById('loading');
            
            // Clear previous errors
            clearErrors();
            
            // Validate all fields
            if (!validateAllFields(formData)) {
                return;
            }
            
            // Show loading state
            signupBtn.disabled = true;
            loading.style.display = 'block';
            
            try {
                const response = await fetch('/api/member/signup', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        username: formData.name,
                        email: formData.email,
                        password: formData.password,
                        role: formData.role,
                        termsAgreement: formData.termsAgreement
                    })
                });
                
                const data = await response.json();
                
                if (response.ok && data.code === 200) {
                    // Show success message
                    showSuccess('회원가입이 완료되었습니다! 로그인 페이지로 이동합니다...');
                    
                    // Redirect to login after short delay
                    setTimeout(() => {
                        window.location.href = `/auth/login?email=${encodeURIComponent(formData.email)}`;
                    }, 2000);
                    
                } else {
                    // Handle signup failure
                    const errorMessage = data.message || '회원가입에 실패했습니다.';
                    showError('generalError', errorMessage);
                }
                
            } catch (error) {
                console.error('Signup error:', error);
                showError('generalError', '네트워크 오류가 발생했습니다. 잠시 후 다시 시도해주세요.');
            } finally {
                // Hide loading state
                signupBtn.disabled = false;
                loading.style.display = 'none';
            }
        }
        
        function validateAllFields(formData) {
            let isValid = true;
            
            if (!formData.name.trim()) {
                showError('nameError', '이름을 입력해주세요.');
                isValid = false;
            }
            
            if (!validateEmailFormat(formData.email)) {
                showError('emailError', '올바른 이메일 형식을 입력해주세요.');
                isValid = false;
            }
            
            if (!formData.role) {
                showError('roleError', '역할을 선택해주세요.');
                isValid = false;
            }
            
            if (formData.password.length < 6) {
                showError('passwordError', '비밀번호는 6자 이상이어야 합니다.');
                isValid = false;
            }
            
            if (formData.password !== formData.confirmPassword) {
                showError('confirmPasswordError', '비밀번호가 일치하지 않습니다.');
                isValid = false;
            }
            
            if (!formData.termsAgreement) {
                showError('termsError', '이용약관 및 개인정보처리방침에 동의해주세요.');
                isValid = false;
            }
            
            return isValid;
        }
        
        function validateName() {
            const name = document.getElementById('name').value.trim();
            const nameGroup = document.getElementById('name').parentElement;
            
            if (name.length >= 2) {
                nameGroup.classList.remove('invalid');
                nameGroup.classList.add('valid');
                showValid('nameValid', '✓ 사용 가능한 이름입니다.');
                hideError('nameError');
                validation.name = true;
            } else if (name.length > 0) {
                nameGroup.classList.remove('valid');
                nameGroup.classList.add('invalid');
                showError('nameError', '이름은 2자 이상이어야 합니다.');
                hideValid('nameValid');
                validation.name = false;
            } else {
                nameGroup.classList.remove('valid', 'invalid');
                hideError('nameError');
                hideValid('nameValid');
                validation.name = false;
            }
        }
        
        function validateEmail() {
            const email = document.getElementById('email').value;
            const emailGroup = document.getElementById('email').parentElement;
            
            if (validateEmailFormat(email)) {
                emailGroup.classList.remove('invalid');
                emailGroup.classList.add('valid');
                showValid('emailValid', '✓ 올바른 이메일 형식입니다.');
                hideError('emailError');
                validation.email = true;
            } else if (email.length > 0) {
                emailGroup.classList.remove('valid');
                emailGroup.classList.add('invalid');
                showError('emailError', '올바른 이메일 형식을 입력해주세요.');
                hideValid('emailValid');
                validation.email = false;
            } else {
                emailGroup.classList.remove('valid', 'invalid');
                hideError('emailError');
                hideValid('emailValid');
                validation.email = false;
            }
        }
        
        function validatePassword() {
            const password = document.getElementById('password').value;
            const passwordGroup = document.getElementById('password').parentElement;
            const strengthIndicator = document.getElementById('passwordStrength');
            const strengthFill = document.getElementById('strengthFill');
            const strengthText = document.getElementById('strengthText');
            
            if (password.length > 0) {
                strengthIndicator.style.display = 'block';
                
                const strength = calculatePasswordStrength(password);
                
                if (strength.score >= 3) {
                    passwordGroup.classList.remove('invalid');
                    passwordGroup.classList.add('valid');
                    showValid('passwordValid', '✓ 강력한 비밀번호입니다.');
                    hideError('passwordError');
                    validation.password = true;
                } else if (password.length >= 6) {
                    passwordGroup.classList.remove('invalid', 'valid');
                    hideError('passwordError');
                    hideValid('passwordValid');
                    validation.password = true;
                } else {
                    passwordGroup.classList.remove('valid');
                    passwordGroup.classList.add('invalid');
                    showError('passwordError', '비밀번호는 6자 이상이어야 합니다.');
                    hideValid('passwordValid');
                    validation.password = false;
                }
                
                // Update strength indicator
                strengthFill.style.width = (strength.score * 25) + '%';
                strengthFill.className = 'strength-fill ' + strength.className;
                strengthText.textContent = strength.text;
                
            } else {
                strengthIndicator.style.display = 'none';
                passwordGroup.classList.remove('valid', 'invalid');
                hideError('passwordError');
                hideValid('passwordValid');
                validation.password = false;
            }
            
            // Re-validate confirm password if it has content
            if (document.getElementById('confirmPassword').value) {
                validateConfirmPassword();
            }
        }
        
        function validateConfirmPassword() {
            const password = document.getElementById('password').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            const confirmGroup = document.getElementById('confirmPassword').parentElement;
            
            if (confirmPassword.length > 0) {
                if (password === confirmPassword && password.length >= 6) {
                    confirmGroup.classList.remove('invalid');
                    confirmGroup.classList.add('valid');
                    showValid('confirmPasswordValid', '✓ 비밀번호가 일치합니다.');
                    hideError('confirmPasswordError');
                    validation.confirmPassword = true;
                } else {
                    confirmGroup.classList.remove('valid');
                    confirmGroup.classList.add('invalid');
                    showError('confirmPasswordError', '비밀번호가 일치하지 않습니다.');
                    hideValid('confirmPasswordValid');
                    validation.confirmPassword = false;
                }
            } else {
                confirmGroup.classList.remove('valid', 'invalid');
                hideError('confirmPasswordError');
                hideValid('confirmPasswordValid');
                validation.confirmPassword = false;
            }
        }
        
        function calculatePasswordStrength(password) {
            let score = 0;
            
            if (password.length >= 8) score++;
            if (/[a-z]/.test(password)) score++;
            if (/[A-Z]/.test(password)) score++;
            if (/[0-9]/.test(password)) score++;
            if (/[^A-Za-z0-9]/.test(password)) score++;
            
            const strengths = [
                { score: 0, text: '매우 약함', className: 'strength-weak' },
                { score: 1, text: '약함', className: 'strength-weak' },
                { score: 2, text: '보통', className: 'strength-medium' },
                { score: 3, text: '강함', className: 'strength-medium' },
                { score: 4, text: '매우 강함', className: 'strength-strong' }
            ];
            
            return strengths[Math.min(score, 4)];
        }
        
        function validateEmailFormat(email) {
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            return emailRegex.test(email);
        }
        
        function showError(elementId, message) {
            const errorElement = document.getElementById(elementId);
            errorElement.textContent = message;
            errorElement.style.display = 'block';
        }
        
        function hideError(elementId) {
            const errorElement = document.getElementById(elementId);
            errorElement.style.display = 'none';
        }
        
        function showValid(elementId, message) {
            const validElement = document.getElementById(elementId);
            validElement.textContent = message;
            validElement.style.display = 'block';
        }
        
        function hideValid(elementId) {
            const validElement = document.getElementById(elementId);
            validElement.style.display = 'none';
        }
        
        function showSuccess(message) {
            const successElement = document.getElementById('successMessage');
            successElement.textContent = message;
            successElement.style.display = 'block';
        }
        
        function clearErrors() {
            const errorElements = document.querySelectorAll('.error-message, .success-message');
            errorElements.forEach(element => {
                element.style.display = 'none';
                element.textContent = '';
            });
        }
        
        // Modal functions
        function openTermsModal() {
            document.getElementById('termsModal').style.display = 'block';
            document.body.style.overflow = 'hidden';
        }
        
        function closeTermsModal() {
            document.getElementById('termsModal').style.display = 'none';
            document.body.style.overflow = 'auto';
        }
        
        function openPrivacyModal() {
            document.getElementById('privacyModal').style.display = 'block';
            document.body.style.overflow = 'hidden';
        }
        
        function closePrivacyModal() {
            document.getElementById('privacyModal').style.display = 'none';
            document.body.style.overflow = 'auto';
        }
        
        // Close modal when clicking outside
        window.onclick = function(event) {
            const termsModal = document.getElementById('termsModal');
            const privacyModal = document.getElementById('privacyModal');
            
            if (event.target === termsModal) {
                closeTermsModal();
            }
            if (event.target === privacyModal) {
                closePrivacyModal();
            }
        }
        
        // Terms agreement validation
        function validateTermsAgreement() {
            const termsCheckbox = document.getElementById('termsAgreement');
            const isChecked = termsCheckbox.checked;
            
            if (isChecked) {
                hideError('termsError');
                validation.terms = true;
            } else {
                validation.terms = false;
            }
        }
        
        // Add event listener for terms checkbox
        document.getElementById('termsAgreement').addEventListener('change', validateTermsAgreement);
    </script>
    </div>
</body>
</html>