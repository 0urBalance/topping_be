<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>콜라보를 제안하고 싶으신가요? - Topping</title>

    <!-- Google Tag Manager -->
    <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
    new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
    j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
    'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
    })(window,document,'script','dataLayer','GTM-T5T3CSLT');</script>
    <!-- End Google Tag Manager -->

    <!-- Google tag (gtag.js) -->
    <script async src='https://www.googletagmanager.com/gtag/js?id=G-Y1ZSWHSQD0'></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-Y1ZSWHSQD0');
    </script>

    <!-- MANDATORY: Include framework CSS -->
    <link rel="stylesheet" th:href="@{/css/base.css}">
    <link rel="stylesheet" th:href="@{/css/main.css}">
    <link rel="stylesheet" th:href="@{/css/navbar.css}">
    <link rel="stylesheet"
          href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200"/>
    <link rel="icon" type="image/x-icon" th:href="@{/favicon.ico}">

    <style>
        /* Banner Styles */
        .collaboration-banner {
            position: relative;
            width: 100%;
            height: 300px;
            overflow: hidden;
            margin-bottom: var(--spacing-xl);
        }

        .collaboration-banner .banner-image {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .collaboration-banner .banner-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .collaboration-banner .banner-content {
            background: white;
            padding: var(--spacing-xl) var(--spacing-2xl);
            border-radius: 8px;
            text-align: center;
            display: flex;
            align-items: center;
            gap: var(--spacing-lg);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .collaboration-banner .banner-icon {
            width: 48px;
            height: 48px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
        }

        .collaboration-banner .banner-text h1 {
            font-size: 1.5rem;
            font-weight: bold;
            color: #333;
            margin: 0;
        }

        .collaboration-banner .banner-text p {
            color: #666;
            font-size: 0.875rem;
            margin: var(--spacing-xs) 0 0 0;
        }

        /* Form Container */
        .form-container {
            max-width: 800px;
            margin: 0 auto;
            padding: 0 var(--spacing-lg) var(--spacing-2xl);
        }

        /* Store Selection Section */
        .store-selection-section {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: var(--spacing-lg);
            margin-bottom: var(--spacing-xl);
        }

        .store-selection-section h3 {
            margin: 0 0 var(--spacing-md) 0;
            color: var(--primary-color);
            font-size: 1.125rem;
            font-weight: bold;
        }

        .store-card {
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: var(--spacing-md);
            margin-bottom: var(--spacing-sm);
        }

        .store-card h4 {
            margin: 0 0 var(--spacing-xs) 0;
            font-size: 1rem;
            font-weight: bold;
        }

        .store-card .category {
            background: #e9ecef;
            color: #495057;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: bold;
            display: inline-block;
        }

        /* Form Group Styles */
        .form-group {
            margin-bottom: var(--spacing-lg);
        }

        .form-label {
            display: block;
            font-weight: 600;
            margin-bottom: var(--spacing-sm);
            color: #333;
        }

        .form-label.required::before {
            content: "*";
            color: #dc3545;
            margin-right: 4px;
        }

        .form-control {
            width: 100%;
            padding: var(--spacing-md);
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 1rem;
            box-sizing: border-box;
        }

        .form-control:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px rgba(107, 52, 16, 0.1);
        }

        .form-hint {
            display: block;
            font-size: 0.813rem;
            color: #666;
            margin-top: var(--spacing-xs);
        }

        /* Searchable Select */
        .searchable-select {
            position: relative;
        }

        .searchable-select input {
            width: 100%;
            padding: var(--spacing-md);
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 1rem;
            box-sizing: border-box;
        }

        .searchable-select .dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #ddd;
            border-top: none;
            border-radius: 0 0 6px 6px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
        }

        .searchable-select .dropdown.active {
            display: block;
        }

        .searchable-select .option {
            padding: var(--spacing-md);
            cursor: pointer;
            border-bottom: 1px solid #f1f3f5;
        }

        .searchable-select .option:hover {
            background: #f8f9fa;
        }

        .searchable-select .option.selected {
            background: var(--primary-light);
            color: var(--primary-color);
        }

        /* Benefit Select Styles */
        .benefit-select-container {
            border: 1px solid #ddd;
            border-radius: 6px;
            overflow: hidden;
        }

        .benefit-select-trigger {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: var(--spacing-md);
            background: white;
            cursor: pointer;
        }

        .benefit-select-trigger .placeholder {
            color: #666;
        }

        .benefit-select-trigger .selected-text {
            color: #333;
        }

        .benefit-options {
            border-top: 1px solid #ddd;
            background: #fafafa;
        }

        .benefit-option {
            padding: var(--spacing-md);
            cursor: pointer;
            border-bottom: 1px solid #eee;
            transition: background-color 0.2s ease;
        }

        .benefit-option:last-child {
            border-bottom: none;
        }

        .benefit-option:hover {
            background-color: #f0f0f0;
        }

        .benefit-option.selected {
            background-color: var(--primary-light);
        }

        .benefit-title {
            font-weight: 600;
            color: #333;
            margin-bottom: 4px;
        }

        .benefit-subtitle {
            font-size: 0.813rem;
            color: #666;
            line-height: 1.4;
        }

        /* Date Range Styles */
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: var(--spacing-lg);
        }

        .date-range-input {
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
            position: relative;
        }

        .date-range-input .form-control {
            flex: 1;
            text-align: center;
            cursor: pointer;
        }

        .date-separator {
            color: #666;
            font-weight: 500;
        }

        .calendar-icon {
            position: absolute;
            right: var(--spacing-md);
            color: #666;
            pointer-events: none;
        }

        /* Calendar Styles */
        .calendar {
            background: white;
            border: 1px solid #e9ecef;
            border-radius: 12px;
            overflow: hidden;
            margin-top: var(--spacing-sm);
            display: none;
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
            position: absolute;
            z-index: 1000;
            width: 100%;
        }

        .calendar.active {
            display: block;
        }

        .calendar-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: var(--spacing-md);
            background: var(--primary-light);
            border-bottom: 1px solid #e9ecef;
        }

        .calendar-nav {
            background: white;
            border: 1px solid #e9ecef;
            font-size: 1rem;
            cursor: pointer;
            padding: var(--spacing-xs) var(--spacing-sm);
            border-radius: 4px;
            color: var(--primary-color);
            font-weight: bold;
        }

        .calendar-nav:hover {
            background: var(--primary-color);
            color: white;
        }

        .calendar-month {
            font-weight: bold;
            font-size: 1rem;
            color: var(--primary-color);
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
        }

        .calendar-day-header {
            padding: var(--spacing-sm);
            text-align: center;
            font-size: 0.75rem;
            font-weight: bold;
            color: #666;
            background: #f8f9fa;
        }

        .calendar-day {
            padding: var(--spacing-sm);
            text-align: center;
            cursor: pointer;
            font-size: 0.875rem;
            min-height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }

        .calendar-day:hover:not(.other-month) {
            background: var(--primary-light);
            color: var(--primary-color);
        }

        .calendar-day.other-month {
            color: #ccc;
            cursor: not-allowed;
        }

        .calendar-day.today {
            background: #2563eb;
            color: white;
            border-radius: 4px;
            font-weight: bold;
        }

        .calendar-day.selected {
            background: var(--primary-color);
            color: white;
            border-radius: 4px;
            font-weight: bold;
        }

        .calendar-day.in-range {
            background: #d4a574;
            color: white;
        }

        /* Simple Select with Visible Options */
        .simple-select-container {
            border: 1px solid #ddd;
            border-radius: 6px;
            overflow: hidden;
        }

        .simple-select-trigger {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: var(--spacing-md);
            background: white;
            cursor: pointer;
        }

        .simple-select-trigger .placeholder {
            color: #666;
        }

        .simple-select-options {
            border-top: 1px solid #eee;
            background: #fafafa;
        }

        .simple-option {
            padding: var(--spacing-md);
            cursor: pointer;
            background: white;
            border-bottom: 1px solid #eee;
            transition: background-color 0.2s ease;
        }

        .simple-option:last-child {
            border-bottom: none;
        }

        .simple-option:hover,
        .simple-option.selected {
            background-color: var(--primary-light);
        }

        /* Submit Button */
        .form-actions {
            text-align: center;
            margin-top: var(--spacing-xl);
        }

        .btn-submit {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: var(--spacing-md) var(--spacing-2xl);
            font-size: 1rem;
            font-weight: 600;
            border-radius: 24px;
            cursor: pointer;
            transition: background-color 0.2s ease;
            min-width: 200px;
        }

        .btn-submit:hover {
            background-color: #5a2d0d;
        }

        /* Alert Styles */
        .alert {
            padding: var(--spacing-md);
            border-radius: 6px;
            margin-bottom: var(--spacing-lg);
        }

        .alert-error {
            background-color: #fee2e2;
            border: 1px solid #fecaca;
            color: #dc2626;
        }

        /* Mobile Responsive */
        @media (max-width: 768px) {
            .collaboration-banner {
                height: 200px;
            }

            .collaboration-banner .banner-content {
                flex-direction: column;
                padding: var(--spacing-lg);
                gap: var(--spacing-sm);
            }

            .collaboration-banner .banner-text h1 {
                font-size: 1.125rem;
            }

            .form-container {
                padding: 0 var(--spacing-md) var(--spacing-xl);
            }

            .form-row {
                grid-template-columns: 1fr;
                gap: var(--spacing-md);
            }

            .date-range-input {
                flex-direction: column;
            }

            .date-separator {
                display: none;
            }

            .btn-submit {
                width: 100%;
            }
        }
    </style>
</head>
<body class="main-body">
    <!-- Google Tag Manager (noscript) -->
    <noscript><iframe src='https://www.googletagmanager.com/ns.html?id=GTM-T5T3CSLT'
    height='0' width='0' style='display:none;visibility:hidden'></iframe></noscript>
    <!-- End Google Tag Manager (noscript) -->

    <!-- MANDATORY: Include navbar -->
    <div th:replace="~{fragments/navbar :: navbar}"></div>

    <!-- MANDATORY: Main content with proper layout -->
    <main id="main-content" class="main-content">
        <!-- Banner Image Section -->
        <div class="collaboration-banner">
            <img th:src="@{/image/collaboration/proposal-banner.png}" alt="콜라보 제안 배너" class="banner-image">
            <div class="banner-overlay">
                <div class="banner-content">
                    <div class="banner-icon">
                        <svg width="48" height="48" viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <rect width="12" height="12" x="6" y="6" rx="2" fill="#E8B89D"/>
                            <rect width="12" height="12" x="30" y="6" rx="2" fill="#6B3410"/>
                            <rect width="12" height="12" x="6" y="30" rx="2" fill="#4A7C59"/>
                            <rect width="12" height="12" x="30" y="30" rx="2" fill="#F4D03F"/>
                            <rect width="12" height="24" x="18" y="12" rx="2" fill="#E8B89D" transform="rotate(90 18 12)"/>
                        </svg>
                    </div>
                    <div class="banner-text">
                        <h1>콜라보를 제안하고 싶으신가요?</h1>
                        <p>다양한 콜라보 실현을 위해 직접 제안해 보세요.</p>
                    </div>
                </div>
            </div>
        </div>

        <div class="form-container">
            <!-- Error Messages -->
            <div th:if="${param.error}" class="alert alert-error">
                <span th:if="${param.error[0] == 'title_required'}">제목을 입력해주세요.</span>
                <span th:if="${param.error[0] == 'description_required'}">각자의 역할을 입력해주세요.</span>
                <span th:if="${param.error[0] == 'target_store_required'}">콜라보할 가게를 선택해주세요.</span>
                <span th:if="${param.error[0] == 'invalid_date_range'}">종료일이 시작일보다 이후여야 합니다.</span>
                <span th:if="${param.error[0] == 'invalid_date_format'}">올바른 날짜 형식을 입력해주세요.</span>
            </div>

            <form action="/collaborations/apply" method="post" id="collaborationForm">

                <!-- Store Selection Section -->
                <div class="store-selection-section">
                    <!-- Business Owner's Store -->
                    <div sec:authorize="hasRole('ROLE_BUSINESS_OWNER')">
                        <h3>내 가게</h3>
                        <div th:if="${userStore}" class="store-card">
                            <h4 th:text="${userStore.name}">가게명</h4>
                            <span class="category" th:text="${userStore.category}">카테고리</span>
                            <input type="hidden" name="sourceStoreId" th:value="${userStore.uuid}">
                        </div>
                    </div>

                    <!-- Target Store Selection -->
                    <h3 style="margin-top: var(--spacing-lg);">콜라보하고 싶은 가게</h3>
                    <div class="searchable-select">
                        <input type="text" placeholder="가게를 검색하세요" class="store-search-input" id="storeSearchInput">
                        <div class="dropdown" id="storeDropdown">
                            <div th:each="store : ${allStores}"
                                 class="option"
                                 th:data-value="${store.uuid}"
                                 th:data-name="${store.name}"
                                 th:data-category="${store.category}"
                                 th:text="${store.name + ' - ' + store.category}">
                            </div>
                        </div>
                    </div>
                    <input type="hidden" name="targetStoreId" id="selectedStoreId">

                    <!-- Product Selection (Optional) -->
                    <div style="margin-top: var(--spacing-md);">
                        <label class="form-label">상대방 상품 (선택사항)</label>
                        <div class="searchable-select">
                            <input type="text" placeholder="상품을 선택하세요" class="product-search-input" id="productSearchInput" disabled>
                            <div class="dropdown" id="productDropdown"></div>
                        </div>
                        <input type="hidden" name="targetProductId" id="selectedProductId">
                        <span class="form-hint">가게를 선택하면 해당 가게의 상품을 선택할 수 있습니다.</span>
                    </div>

                    <!-- Proposer Product Selection (Optional) -->
                    <div sec:authorize="hasRole('ROLE_BUSINESS_OWNER')" style="margin-top: var(--spacing-md);">
                        <label class="form-label">내 상품 (선택사항)</label>
                        <div class="searchable-select">
                            <input type="text" placeholder="내 상품을 선택하세요" class="proposer-product-search-input" id="proposerProductInput">
                            <div class="dropdown" id="proposerProductDropdown">
                                <div th:if="${userProducts != null and !userProducts.isEmpty()}">
                                    <div th:each="product : ${userProducts}"
                                         class="option"
                                         th:data-value="${product.uuid}"
                                         th:data-name="${product.name}"
                                         th:text="${product.name}">
                                    </div>
                                </div>
                                <div th:if="${userProducts == null or userProducts.isEmpty()}" class="option disabled">
                                    등록된 상품이 없습니다
                                </div>
                            </div>
                        </div>
                        <input type="hidden" name="proposerProductId" id="selectedProposerProductId">
                    </div>
                </div>

                <!-- Proposal Title -->
                <div class="form-group">
                    <label class="form-label required">제안 제목</label>
                    <input type="text"
                           class="form-control"
                           name="collaborationTitle"
                           required
                           placeholder="예시) 저희 가게 빵과 사장님 가게 햄으로 샌드위치 만들기">
                </div>

                <!-- Expected Benefit -->
                <div class="form-group">
                    <label class="form-label required">원하는 기대 효과</label>
                    <div class="benefit-select-container">
                        <div class="benefit-select-trigger" id="benefitSelectTrigger">
                            <span class="placeholder" id="benefitPlaceholder">선택 또는 입력하세요.</span>
                            <span class="material-symbols-outlined">expand_more</span>
                        </div>
                        <div class="benefit-options" id="benefitOptions">
                            <div class="benefit-option" data-value="NEW_CUSTOMERS">
                                <div class="benefit-title">새로운 손님 유입 및 매출 증가를 기대해요.</div>
                                <div class="benefit-subtitle">서로 단골손님을 소개하거나, 함께 이벤트/쿠폰을 진행해 가게 방문객을 늘리고 싶어요.</div>
                            </div>
                            <div class="benefit-option" data-value="REDUCE_MARKETING">
                                <div class="benefit-title">마케팅 비용을 줄이고 싶어요.</div>
                                <div class="benefit-subtitle">전단지-홍보물-온라인 홍보 등을 혼자 할 때보다 부담 없이 같이 하길 원해요.</div>
                            </div>
                            <div class="benefit-option" data-value="UNIQUE_PRODUCTS">
                                <div class="benefit-title">가게만의 특별한 상품-세트를 만들어 경쟁력을 높이고 싶어요.</div>
                                <div class="benefit-subtitle">다른 가게와 콜라보 제품/메뉴/선물세트 같은 차별화된 판매 포인트를 만들고 싶어요.</div>
                            </div>
                            <div class="benefit-option" data-value="SHARE_COSTS">
                                <div class="benefit-title">운영 비용-설비 부담을 나누고 싶어요.</div>
                                <div class="benefit-subtitle">재료 공동 구매, 기계/공간 공유 등으로 운영 비용을 줄이고 효율적으로 운영하고 싶어요.</div>
                            </div>
                        </div>
                    </div>
                    <input type="hidden" name="expectedBenefit" id="expectedBenefitInput">
                </div>

                <!-- Date Range Pickers -->
                <div class="form-row">
                    <!-- Recruitment Period -->
                    <div class="form-group">
                        <label class="form-label required">모집 기간</label>
                        <div class="date-range-input" style="position: relative;">
                            <input type="text" class="form-control" placeholder="시작일" id="recruitStartDisplay" readonly onclick="toggleCalendar('recruit')">
                            <span class="date-separator">-</span>
                            <input type="text" class="form-control" placeholder="마감일" id="recruitEndDisplay" readonly onclick="toggleCalendar('recruit')">
                            <div class="calendar" id="recruitCalendar">
                                <div class="calendar-header">
                                    <button type="button" class="calendar-nav" onclick="changeMonth('recruit', -1)">&lt;</button>
                                    <span class="calendar-month" id="recruitCalendarMonth">2025년 1월</span>
                                    <button type="button" class="calendar-nav" onclick="changeMonth('recruit', 1)">&gt;</button>
                                </div>
                                <div class="calendar-grid" id="recruitCalendarDays">
                                    <div class="calendar-day-header">일</div>
                                    <div class="calendar-day-header">월</div>
                                    <div class="calendar-day-header">화</div>
                                    <div class="calendar-day-header">수</div>
                                    <div class="calendar-day-header">목</div>
                                    <div class="calendar-day-header">금</div>
                                    <div class="calendar-day-header">토</div>
                                </div>
                            </div>
                        </div>
                        <input type="hidden" name="startDate" id="recruitStartInput">
                        <input type="hidden" name="endDate" id="recruitEndInput">
                    </div>

                    <!-- Collaboration Period -->
                    <div class="form-group">
                        <label class="form-label required">콜라보 진행 기간</label>
                        <div class="date-range-input" style="position: relative;">
                            <input type="text" class="form-control" placeholder="시작일" id="collabStartDisplay" readonly onclick="toggleCalendar('collab')">
                            <span class="date-separator">-</span>
                            <input type="text" class="form-control" placeholder="마감일" id="collabEndDisplay" readonly onclick="toggleCalendar('collab')">
                            <div class="calendar" id="collabCalendar">
                                <div class="calendar-header">
                                    <button type="button" class="calendar-nav" onclick="changeMonth('collab', -1)">&lt;</button>
                                    <span class="calendar-month" id="collabCalendarMonth">2025년 1월</span>
                                    <button type="button" class="calendar-nav" onclick="changeMonth('collab', 1)">&gt;</button>
                                </div>
                                <div class="calendar-grid" id="collabCalendarDays">
                                    <div class="calendar-day-header">일</div>
                                    <div class="calendar-day-header">월</div>
                                    <div class="calendar-day-header">화</div>
                                    <div class="calendar-day-header">수</div>
                                    <div class="calendar-day-header">목</div>
                                    <div class="calendar-day-header">금</div>
                                    <div class="calendar-day-header">토</div>
                                </div>
                            </div>
                        </div>
                        <input type="hidden" name="collaborationStartDate" id="collabStartInput">
                        <input type="hidden" name="collaborationEndDate" id="collabEndInput">
                    </div>
                </div>

                <!-- Respective Roles -->
                <div class="form-group">
                    <label class="form-label required">각자의 역할</label>
                    <textarea class="form-control"
                              name="description"
                              rows="4"
                              required
                              placeholder="예시) 저희 매장은 이걸 할게요! 사장님 가게는 이걸 해주셨으면 해요."></textarea>
                    <span class="form-hint">역할을 명확히 나누면 서로 오해할 일이 없어요.</span>
                </div>

                <!-- Revenue Structure & Location -->
                <div class="form-row">
                    <!-- Revenue Structure -->
                    <div class="form-group">
                        <label class="form-label required">수익 배분 구조</label>
                        <div class="simple-select-container">
                            <div class="simple-select-trigger" id="revenueSelectTrigger">
                                <span class="placeholder" id="revenuePlaceholder">선택 또는 입력하세요.</span>
                                <span class="material-symbols-outlined">expand_more</span>
                            </div>
                            <div class="simple-select-options" id="revenueOptions">
                                <div class="simple-option" data-value="채팅으로 협의">채팅으로 협의</div>
                                <div class="simple-option" data-value="각자 판매 대금 정산">각자 판매 대금 정산</div>
                            </div>
                        </div>
                        <input type="hidden" name="revenueStructure" id="revenueStructureInput">
                    </div>

                    <!-- Collaboration Location -->
                    <div class="form-group">
                        <label class="form-label required">콜라보 장소</label>
                        <div class="simple-select-container">
                            <div class="simple-select-trigger" id="locationSelectTrigger">
                                <span class="placeholder" id="locationPlaceholder">콜라보 장소를 선택하세요.</span>
                                <span class="material-symbols-outlined">expand_more</span>
                            </div>
                            <div class="simple-select-options" id="locationOptions">
                                <div class="simple-option" data-value="이후 협의">이후 협의</div>
                                <div class="simple-option" data-value="각각 픽업">각각 픽업</div>
                            </div>
                        </div>
                        <input type="hidden" name="collaborationLocation" id="collaborationLocationInput">
                    </div>
                </div>

                <!-- Submit Button -->
                <div class="form-actions">
                    <button type="submit" class="btn-submit">제안하기</button>
                </div>
            </form>
        </div>
    </main>

    <!-- MANDATORY: Include footer -->
    <div th:replace="~{fragments/footer :: footer}"></div>

    <!-- MANDATORY: Include common modals -->
    <div th:replace="~{fragments/modals :: policy-modals}"></div>

    <!-- MANDATORY: Include framework JavaScript -->
    <script th:src="@{/js/common.js}"></script>
    <script th:src="@{/js/main-common.js}"></script>

    <!-- Store-Product Data Mapping -->
    <script th:inline="javascript">
        let storeData = {};
        try {
            const storeDataRaw = /*[[${storeDataJson}]]*/ '{}';
            if (typeof storeDataRaw === 'string') {
                storeData = JSON.parse(storeDataRaw);
            } else {
                storeData = storeDataRaw;
            }
        } catch (error) {
            console.error('Error parsing store data JSON:', error);
            storeData = {};
        }
    </script>

    <script>
        // Calendar State
        const calendarState = {
            recruit: {
                currentDate: new Date(),
                startDate: null,
                endDate: null
            },
            collab: {
                currentDate: new Date(),
                startDate: null,
                endDate: null
            }
        };

        // Toggle Calendar
        function toggleCalendar(type) {
            const calendar = document.getElementById(type + 'Calendar');
            const isActive = calendar.classList.contains('active');

            // Close all calendars first
            document.querySelectorAll('.calendar').forEach(c => c.classList.remove('active'));

            if (!isActive) {
                calendar.classList.add('active');
                generateCalendar(type);
            }
        }

        // Change Month
        function changeMonth(type, delta) {
            calendarState[type].currentDate.setMonth(calendarState[type].currentDate.getMonth() + delta);
            generateCalendar(type);
        }

        // Generate Calendar
        function generateCalendar(type) {
            const state = calendarState[type];
            const year = state.currentDate.getFullYear();
            const month = state.currentDate.getMonth();

            const monthNames = ['1월', '2월', '3월', '4월', '5월', '6월', '7월', '8월', '9월', '10월', '11월', '12월'];
            document.getElementById(type + 'CalendarMonth').textContent = `${year}년 ${monthNames[month]}`;

            const firstDay = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const daysInPrevMonth = new Date(year, month, 0).getDate();

            const calendarGrid = document.getElementById(type + 'CalendarDays');

            // Remove existing day elements (keep headers)
            const existingDays = calendarGrid.querySelectorAll('.calendar-day');
            existingDays.forEach(day => day.remove());

            // Previous month days
            for (let i = firstDay - 1; i >= 0; i--) {
                const day = daysInPrevMonth - i;
                const dayEl = createDayElement(type, day, true, new Date(year, month - 1, day));
                calendarGrid.appendChild(dayEl);
            }

            // Current month days
            for (let day = 1; day <= daysInMonth; day++) {
                const dayEl = createDayElement(type, day, false, new Date(year, month, day));
                calendarGrid.appendChild(dayEl);
            }

            // Next month days to fill remaining cells
            const totalCells = firstDay + daysInMonth;
            const remainingCells = (7 - (totalCells % 7)) % 7;
            for (let day = 1; day <= remainingCells; day++) {
                const dayEl = createDayElement(type, day, true, new Date(year, month + 1, day));
                calendarGrid.appendChild(dayEl);
            }
        }

        // Create Day Element
        function createDayElement(type, day, isOtherMonth, date) {
            const state = calendarState[type];
            const dayEl = document.createElement('div');
            dayEl.className = 'calendar-day';
            dayEl.textContent = day;

            if (isOtherMonth) {
                dayEl.classList.add('other-month');
            }

            const today = new Date();
            today.setHours(0, 0, 0, 0);

            if (date.toDateString() === today.toDateString()) {
                dayEl.classList.add('today');
            }

            if (state.startDate && date.toDateString() === state.startDate.toDateString()) {
                dayEl.classList.add('selected');
            }
            if (state.endDate && date.toDateString() === state.endDate.toDateString()) {
                dayEl.classList.add('selected');
            }

            if (state.startDate && state.endDate && date > state.startDate && date < state.endDate) {
                dayEl.classList.add('in-range');
            }

            if (!isOtherMonth) {
                dayEl.addEventListener('click', () => selectDate(type, date));
            }

            return dayEl;
        }

        // Select Date
        function selectDate(type, date) {
            const state = calendarState[type];

            if (!state.startDate || (state.startDate && state.endDate)) {
                state.startDate = date;
                state.endDate = null;
            } else if (state.startDate && !state.endDate) {
                if (date < state.startDate) {
                    state.endDate = state.startDate;
                    state.startDate = date;
                } else {
                    state.endDate = date;
                }
            }

            updateDateDisplay(type);
            generateCalendar(type);

            if (state.startDate && state.endDate) {
                setTimeout(() => {
                    document.getElementById(type + 'Calendar').classList.remove('active');
                }, 300);
            }
        }

        // Update Date Display
        function updateDateDisplay(type) {
            const state = calendarState[type];
            const startDisplay = document.getElementById(type + 'StartDisplay');
            const endDisplay = document.getElementById(type + 'EndDisplay');
            const startInput = document.getElementById(type + 'StartInput');
            const endInput = document.getElementById(type + 'EndInput');

            if (state.startDate) {
                startDisplay.value = formatDateKorean(state.startDate);
                startInput.value = formatDateISO(state.startDate);
            } else {
                startDisplay.value = '';
                startInput.value = '';
            }

            if (state.endDate) {
                endDisplay.value = formatDateKorean(state.endDate);
                endInput.value = formatDateISO(state.endDate);
            } else {
                endDisplay.value = '';
                endInput.value = '';
            }
        }

        // Format Date Korean
        function formatDateKorean(date) {
            return `${date.getFullYear()}.${String(date.getMonth() + 1).padStart(2, '0')}.${String(date.getDate()).padStart(2, '0')}`;
        }

        // Format Date ISO
        function formatDateISO(date) {
            return date.toISOString().split('T')[0];
        }

        // Benefit Select
        function setupBenefitSelect() {
            const options = document.querySelectorAll('.benefit-option');
            const hiddenInput = document.getElementById('expectedBenefitInput');
            const placeholder = document.getElementById('benefitPlaceholder');

            options.forEach(option => {
                option.addEventListener('click', function() {
                    options.forEach(opt => opt.classList.remove('selected'));
                    this.classList.add('selected');
                    hiddenInput.value = this.dataset.value;
                    placeholder.textContent = this.querySelector('.benefit-title').textContent;
                    placeholder.classList.remove('placeholder');
                    placeholder.classList.add('selected-text');
                });
            });
        }

        // Simple Select
        function setupSimpleSelect(containerId, inputId, placeholderId) {
            const container = document.getElementById(containerId);
            const options = container.querySelectorAll('.simple-option');
            const hiddenInput = document.getElementById(inputId);
            const placeholder = document.getElementById(placeholderId);

            options.forEach(option => {
                option.addEventListener('click', function() {
                    options.forEach(opt => opt.classList.remove('selected'));
                    this.classList.add('selected');
                    hiddenInput.value = this.dataset.value;
                    placeholder.textContent = this.dataset.value;
                    placeholder.classList.remove('placeholder');
                    placeholder.classList.add('selected-text');
                });
            });
        }

        // Store Search
        function setupStoreSearch() {
            const input = document.getElementById('storeSearchInput');
            const dropdown = document.getElementById('storeDropdown');
            const options = dropdown.querySelectorAll('.option');
            const hiddenInput = document.getElementById('selectedStoreId');

            input.addEventListener('input', function() {
                const searchTerm = this.value.toLowerCase();
                let hasVisible = false;

                options.forEach(option => {
                    const text = option.textContent.toLowerCase();
                    if (text.includes(searchTerm)) {
                        option.style.display = 'block';
                        hasVisible = true;
                    } else {
                        option.style.display = 'none';
                    }
                });

                dropdown.classList.toggle('active', hasVisible && searchTerm.length > 0);
            });

            input.addEventListener('focus', function() {
                dropdown.classList.add('active');
            });

            input.addEventListener('blur', function() {
                setTimeout(() => dropdown.classList.remove('active'), 200);
            });

            options.forEach(option => {
                option.addEventListener('click', function() {
                    const value = this.dataset.value;
                    const name = this.dataset.name;

                    input.value = name;
                    hiddenInput.value = value;
                    dropdown.classList.remove('active');

                    // Load products for this store
                    loadStoreProducts(value);
                });
            });
        }

        // Load Store Products
        function loadStoreProducts(storeUuid) {
            const productInput = document.getElementById('productSearchInput');
            const productDropdown = document.getElementById('productDropdown');
            const productHidden = document.getElementById('selectedProductId');

            productDropdown.innerHTML = '';
            productInput.value = '';
            productHidden.value = '';

            const store = storeData[storeUuid];

            if (!store || !store.products || store.products.length === 0) {
                productDropdown.innerHTML = '<div class="option disabled">등록된 상품이 없습니다</div>';
                productInput.disabled = true;
                productInput.placeholder = '등록된 상품이 없습니다';
                return;
            }

            productInput.disabled = false;
            productInput.placeholder = '상품을 선택하세요';

            store.products.filter(p => p.isAvailable).forEach(product => {
                const option = document.createElement('div');
                option.className = 'option';
                option.dataset.value = product.uuid;
                option.dataset.name = product.name;
                option.textContent = product.name + (product.price ? ' - ' + product.price.toLocaleString() + '원' : '');

                option.addEventListener('click', function() {
                    productInput.value = product.name;
                    productHidden.value = product.uuid;
                    productDropdown.classList.remove('active');
                });

                productDropdown.appendChild(option);
            });

            setupProductSearch();
        }

        // Product Search
        function setupProductSearch() {
            const input = document.getElementById('productSearchInput');
            const dropdown = document.getElementById('productDropdown');

            input.addEventListener('input', function() {
                const searchTerm = this.value.toLowerCase();
                const options = dropdown.querySelectorAll('.option:not(.disabled)');
                let hasVisible = false;

                options.forEach(option => {
                    const text = option.textContent.toLowerCase();
                    if (text.includes(searchTerm)) {
                        option.style.display = 'block';
                        hasVisible = true;
                    } else {
                        option.style.display = 'none';
                    }
                });

                dropdown.classList.toggle('active', hasVisible);
            });

            input.addEventListener('focus', function() {
                if (!this.disabled) {
                    dropdown.classList.add('active');
                }
            });

            input.addEventListener('blur', function() {
                setTimeout(() => dropdown.classList.remove('active'), 200);
            });
        }

        // Proposer Product Search
        function setupProposerProductSearch() {
            const input = document.getElementById('proposerProductInput');
            const dropdown = document.getElementById('proposerProductDropdown');
            const hiddenInput = document.getElementById('selectedProposerProductId');

            if (!input || !dropdown) return;

            const options = dropdown.querySelectorAll('.option:not(.disabled)');

            input.addEventListener('input', function() {
                const searchTerm = this.value.toLowerCase();
                let hasVisible = false;

                options.forEach(option => {
                    const text = option.textContent.toLowerCase();
                    if (text.includes(searchTerm)) {
                        option.style.display = 'block';
                        hasVisible = true;
                    } else {
                        option.style.display = 'none';
                    }
                });

                dropdown.classList.toggle('active', hasVisible && searchTerm.length > 0);
            });

            input.addEventListener('focus', function() {
                if (options.length > 0) {
                    dropdown.classList.add('active');
                }
            });

            input.addEventListener('blur', function() {
                setTimeout(() => dropdown.classList.remove('active'), 200);
            });

            options.forEach(option => {
                option.addEventListener('click', function() {
                    input.value = this.dataset.name;
                    hiddenInput.value = this.dataset.value;
                    dropdown.classList.remove('active');
                });
            });
        }

        // Form Validation
        document.getElementById('collaborationForm').addEventListener('submit', function(e) {
            const title = document.querySelector('input[name="collaborationTitle"]').value.trim();
            const description = document.querySelector('textarea[name="description"]').value.trim();
            const targetStoreId = document.getElementById('selectedStoreId').value;
            const expectedBenefit = document.getElementById('expectedBenefitInput').value;
            const recruitStart = document.getElementById('recruitStartInput').value;
            const recruitEnd = document.getElementById('recruitEndInput').value;
            const collabStart = document.getElementById('collabStartInput').value;
            const collabEnd = document.getElementById('collabEndInput').value;
            const revenueStructure = document.getElementById('revenueStructureInput').value;
            const collaborationLocation = document.getElementById('collaborationLocationInput').value;

            if (!title) {
                alert('제안 제목을 입력해주세요.');
                e.preventDefault();
                return;
            }

            if (!targetStoreId) {
                alert('콜라보하고 싶은 가게를 선택해주세요.');
                e.preventDefault();
                return;
            }

            if (!expectedBenefit) {
                alert('원하는 기대 효과를 선택해주세요.');
                e.preventDefault();
                return;
            }

            if (!recruitStart || !recruitEnd) {
                alert('모집 기간을 선택해주세요.');
                e.preventDefault();
                return;
            }

            if (new Date(recruitEnd) <= new Date(recruitStart)) {
                alert('모집 기간의 종료일이 시작일보다 이후여야 합니다.');
                e.preventDefault();
                return;
            }

            if (!collabStart || !collabEnd) {
                alert('콜라보 진행 기간을 선택해주세요.');
                e.preventDefault();
                return;
            }

            if (new Date(collabEnd) <= new Date(collabStart)) {
                alert('콜라보 진행 기간의 종료일이 시작일보다 이후여야 합니다.');
                e.preventDefault();
                return;
            }

            if (!description) {
                alert('각자의 역할을 입력해주세요.');
                e.preventDefault();
                return;
            }

            if (!revenueStructure) {
                alert('수익 배분 구조를 선택해주세요.');
                e.preventDefault();
                return;
            }

            if (!collaborationLocation) {
                alert('콜라보 장소를 선택해주세요.');
                e.preventDefault();
                return;
            }
        });

        // Close calendar when clicking outside
        document.addEventListener('click', function(e) {
            if (!e.target.closest('.date-range-input')) {
                document.querySelectorAll('.calendar').forEach(c => c.classList.remove('active'));
            }
            if (!e.target.closest('.searchable-select')) {
                document.querySelectorAll('.searchable-select .dropdown').forEach(d => d.classList.remove('active'));
            }
        });

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            setupBenefitSelect();
            setupSimpleSelect('revenueOptions', 'revenueStructureInput', 'revenuePlaceholder');
            setupSimpleSelect('locationOptions', 'collaborationLocationInput', 'locationPlaceholder');
            setupStoreSearch();
            setupProposerProductSearch();
        });
    </script>
</body>
</html>
