<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Page - Topping</title>
    
    <!-- Google Tag Manager -->
    <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
    new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
    j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
    'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
    })(window,document,'script','dataLayer','GTM-T5T3CSLT');</script>
    <!-- End Google Tag Manager -->

    <!-- Google tag (gtag.js) -->
    <script async src='https://www.googletagmanager.com/gtag/js?id=G-Y1ZSWHSQD0'></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-Y1ZSWHSQD0');
    </script>
    <link rel="stylesheet" th:href="@{/css/navbar.css}">
    <link rel="stylesheet" th:href="@{/css/base.css}">
    <link
            rel="stylesheet"
            href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200"
    />
    <style>
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            margin: 0; 
            margin-left: 160px; /* Account for sidebar */
            padding: 0;
            background: linear-gradient(135deg, #87604F 0%, #6f4f41 100%); 
            min-height: 100vh; 
            transition: margin-left 0.3s ease;
        }
        
        @media (max-width: 768px) {
            body {
                margin-left: 0; /* No sidebar offset on mobile */
            }
        }
        .container { max-width: 1400px; margin: 0 auto; padding: 20px; }
        .header { text-align: center; margin-bottom: 40px; color: white; }
        .header h1 { font-size: 2.5rem; margin-bottom: 10px; font-weight: 700; }
        .header p { font-size: 1.1rem; opacity: 0.9; }
        .user-welcome { background: rgba(255,255,255,0.1); backdrop-filter: blur(10px); border-radius: 15px; padding: 20px; margin-bottom: 30px; color: white; text-align: center; }
        .user-welcome h2 { margin: 0; font-size: 1.5rem; }
        .user-welcome p { margin: 5px 0 0 0; opacity: 0.8; }

        /* Alert Banner for Pending Actions */
        .alert-banner { background: linear-gradient(135deg, #ff6b6b 0%, #ff8e53 100%); color: white; padding: 15px 20px; border-radius: 10px; margin-bottom: 30px; display: flex; align-items: center; justify-content: space-between; box-shadow: 0 4px 15px rgba(255,107,107,0.3); }
        .alert-banner.hidden { display: none; }
        .alert-content { display: flex; align-items: center; }
        .alert-icon { font-size: 1.5rem; margin-right: 15px; }
        .alert-text h4 { margin: 0; font-size: 1.1rem; }
        .alert-text p { margin: 5px 0 0 0; font-size: 0.9rem; opacity: 0.9; }
        .alert-action { background: rgba(255,255,255,0.2); padding: 8px 16px; border-radius: 5px; text-decoration: none; color: white; font-weight: 600; transition: all 0.3s; }
        .alert-action:hover { background: rgba(255,255,255,0.3); transform: translateY(-1px); }

        /* Stats Grid */
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; margin-bottom: 40px; }
        .stat-card { background: white; border-radius: 15px; padding: 25px; box-shadow: 0 8px 30px rgba(0,0,0,0.1); text-align: center; transition: all 0.3s; cursor: pointer; position: relative; overflow: hidden; }
        .stat-card:hover { transform: translateY(-5px); box-shadow: 0 15px 40px rgba(0,0,0,0.15); }
        .stat-card::before { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 4px; background: var(--card-color, #87604F); }
        .stat-card.applications::before { background: linear-gradient(135deg, #87604F 0%, #6f4f41 100%); }
        .stat-card.ongoing::before { background: linear-gradient(135deg, #87604F 0%, #6f4f41 100%); }
        .stat-card.proposals::before { background: linear-gradient(135deg, #87604F 0%, #6f4f41 100%); }
        .stat-card.products::before { background: linear-gradient(135deg, #87604F 0%, #6f4f41 100%); }
        .stat-card.received::before { background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%); }
        .stat-card.wishlist::before { background: linear-gradient(135deg, #ff6b6b 0%, #ff8e85 100%); }
        .stat-card.store::before { background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%); }
        
        .stat-number { font-size: 3rem; font-weight: 700; color: #333; margin-bottom: 5px; }
        .stat-label { color: #666; font-size: 1.1rem; font-weight: 500; margin-bottom: 15px; }
        .stat-description { font-size: 0.9rem; color: #888; line-height: 1.4; }
        .stat-action { display: inline-block; margin-top: 15px; padding: 8px 16px; background: var(--card-color, #87604F); color: white; text-decoration: none; border-radius: 8px; font-size: 0.9rem; font-weight: 600; transition: all 0.3s; }
        .stat-action:hover { opacity: 0.9; transform: translateY(-1px); }

        /* Quick Actions */
        .quick-actions { background: white; border-radius: 15px; padding: 30px; margin-bottom: 40px; box-shadow: 0 8px 30px rgba(0,0,0,0.1); }
        .quick-actions h3 { margin: 0 0 25px 0; font-size: 1.5rem; color: #333; text-align: center; }
        .actions-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; }
        .action-btn { display: flex; align-items: center; justify-content: center; padding: 15px 20px; background: linear-gradient(135deg, #87604F 0%, #6f4f41 100%); color: white; text-decoration: none; border-radius: 10px; font-weight: 600; transition: all 0.3s; }
        .action-btn:hover { transform: translateY(-2px); box-shadow: 0 5px 20px rgba(102,126,234,0.3); }
        .action-btn.secondary { background: linear-gradient(135deg, #87604F 0%, #6f4f41 100%); }
        .action-btn.success { background: linear-gradient(135deg, #87604F 0%, #6f4f41 100%); }
        .action-btn.warning { background: linear-gradient(135deg, #87604F 0%, #6f4f41 100%); }
        .action-icon { margin-right: 10px; font-size: 1.2rem; }

        /* Recent Activity Section */
        .recent-activity { background: white; border-radius: 15px; padding: 30px; box-shadow: 0 8px 30px rgba(0,0,0,0.1); }
        .recent-activity h3 { margin: 0 0 25px 0; font-size: 1.5rem; color: #333; }
        .activity-item { display: flex; align-items: center; padding: 15px 0; border-bottom: 1px solid #f0f0f0; }
        .activity-item:last-child { border-bottom: none; }
        .activity-icon { width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-right: 15px; font-size: 1.1rem; color: white; }
        .activity-icon.pending { background: #ffc107; }
        .activity-icon.accepted { background: #28a745; }
        .activity-icon.received { background: #17a2b8; }
        .activity-content { flex: 1; }
        .activity-title { font-weight: 600; color: #333; margin-bottom: 3px; }
        .activity-description { font-size: 0.9rem; color: #666; }
        .activity-time { font-size: 0.8rem; color: #999; margin-left: auto; }

        /* Responsive Design */
        @media (max-width: 768px) {
            .container { padding: 15px; }
            .header h1 { font-size: 2rem; }
            .stats-grid { grid-template-columns: 1fr; gap: 15px; }
            .actions-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <!-- Google Tag Manager (noscript) -->
    <noscript><iframe src='https://www.googletagmanager.com/ns.html?id=GTM-T5T3CSLT'
    height='0' width='0' style='display:none;visibility:hidden'></iframe></noscript>
    <!-- End Google Tag Manager (noscript) -->
    
    <div th:replace="fragments/navbar :: navbar"></div>
    
    <div class="container">
        <!-- User Welcome Section -->
        <div class="user-welcome">
            <h2>ì•ˆë…•í•˜ì„¸ìš”, <span th:text="${user.username}">ì‚¬ìš©ìë‹˜</span>ë‹˜!</h2>
            <p>ì˜¤ëŠ˜ë„ ì„±ê³µì ì¸ ì½œë¼ë³´ë ˆì´ì…˜ì„ ìœ„í•´ í•¨ê»˜í•´ìš” ğŸš€</p>
        </div>

        <!-- Access Denied Error Message -->
        <div class="alert-banner" th:if="${param.error != null and param.error[0] == 'access_denied'}">
            <div class="alert-content">
                <div class="alert-icon">ğŸš«</div>
                <div class="alert-text">
                    <h4>ì ‘ê·¼ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤</h4>
                    <p>ìŠ¤í† ì–´ ê´€ë¦¬ ê¸°ëŠ¥ì€ ì‚¬ì—…ì íšŒì›ë§Œ ì´ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤</p>
                </div>
            </div>
            <a href="/upgrade" class="alert-action">ì‚¬ì—…ì ë“±ê¸‰ ì—…ê·¸ë ˆì´ë“œ</a>
        </div>

        <!-- Upgrade Required Info Message -->
        <div class="alert-banner" th:if="${param.info != null and param.info[0] == 'upgrade_required'}" style="background: linear-gradient(135deg, #87604F 0%, #6f4f41 100%);">
            <div class="alert-content">
                <div class="alert-icon">ğŸ’¼</div>
                <div class="alert-text">
                    <h4>ì‚¬ì—…ì ë“±ê¸‰ ì—…ê·¸ë ˆì´ë“œ ì•ˆë‚´</h4>
                    <p>ìŠ¤í† ì–´ ê´€ë¦¬ì™€ ê³ ê¸‰ ê¸°ëŠ¥ì„ ì´ìš©í•˜ë ¤ë©´ ì‚¬ì—…ì ë“±ê¸‰ìœ¼ë¡œ ì—…ê·¸ë ˆì´ë“œí•˜ì„¸ìš”</p>
                </div>
            </div>
            <a href="/contact" class="alert-action">ë¬¸ì˜í•˜ê¸°</a>
        </div>

        <!-- Alert Banner for Pending Actions -->
        <div class="alert-banner" th:classappend="${pendingActionsCount == 0} ? 'hidden' : ''">
            <div class="alert-content">
                <div class="alert-icon">ğŸ””</div>
                <div class="alert-text">
                    <h4>ì²˜ë¦¬ê°€ í•„ìš”í•œ ì‘ì—…ì´ ìˆìŠµë‹ˆë‹¤</h4>
                    <p th:text="${pendingActionsCount} + 'ê°œì˜ ì½œë¼ë³´ ì‹ ì²­ì´ ëŒ€ê¸° ì¤‘ì…ë‹ˆë‹¤'">ì•Œë¦¼ ë‚´ìš©</p>
                </div>
            </div>
            <a href="/mypage/received" class="alert-action">í™•ì¸í•˜ê¸°</a>
        </div>

        <!-- Statistics Grid -->
        <div class="stats-grid">
            <!-- My Applications -->
            <div class="stat-card applications" onclick="location.href='/mypage/applications'">
                <div class="stat-number" th:text="${applicationCount ?: 0}">0</div>
                <div class="stat-label">ë‚´ ì‹ ì²­</div>
                <div class="stat-description">ë‚´ê°€ ì‹ ì²­í•œ ì½œë¼ë³´ í˜„í™©</div>
                <a href="/mypage/applications" class="stat-action" style="--card-color: #87604F">ìì„¸íˆ ë³´ê¸°</a>
            </div>

            <!-- Ongoing Collaborations -->
            <div class="stat-card ongoing" onclick="location.href='/mypage/ongoing'">
                <div class="stat-number" th:text="${ongoingCollaborationCount ?: 0}">0</div>
                <div class="stat-label">ì§„í–‰ì¤‘ ì½œë¼ë³´</div>
                <div class="stat-description">í˜„ì¬ í™œì„± ìƒíƒœì¸ ì½œë¼ë³´</div>
                <a href="/mypage/ongoing" class="stat-action" style="--card-color: #87604F">ê´€ë¦¬í•˜ê¸°</a>
            </div>

            <!-- My Proposals -->
            <div class="stat-card proposals" onclick="location.href='/mypage/collabos'">
                <div class="stat-number" th:text="${proposalCount ?: 0}">0</div>
                <div class="stat-label">ë‚´ ì œì•ˆ</div>
                <div class="stat-description">ë‚´ê°€ ì œì•ˆí•œ ì½œë¼ë³´</div>
                <a href="/mypage/collabos" class="stat-action" style="--card-color: #87604F">ë³´ê¸°</a>
            </div>

            <!-- My Products -->
            <div class="stat-card products" onclick="location.href='/mypage/product'">
                <div class="stat-number" th:text="${productCount ?: 0}">0</div>
                <div class="stat-label">ë“±ë¡í•œ ìƒí’ˆ</div>
                <div class="stat-description">ë‚´ê°€ ë“±ë¡í•œ ìƒí’ˆ ê´€ë¦¬</div>
                <a href="/mypage/product" class="stat-action" style="--card-color: #87604F">ê´€ë¦¬í•˜ê¸°</a>
            </div>

            <!-- Received Applications -->
            <div class="stat-card received" onclick="location.href='/mypage/received'">
                <div class="stat-number" th:text="${receivedApplicationCount ?: 0}">0</div>
                <div class="stat-label">ë°›ì€ ì‹ ì²­</div>
                <div class="stat-description">ë‚´ ìƒí’ˆì— ì˜¨ ì½œë¼ë³´ ì‹ ì²­</div>
                <a href="/mypage/received" class="stat-action" style="--card-color: #a8edea">ì²˜ë¦¬í•˜ê¸°</a>
            </div>

            <!-- Wishlist -->
            <div class="stat-card wishlist" onclick="location.href='/mypage/wishlist'">
                <div class="stat-number" th:text="${wishlistCount ?: 0}">0</div>
                <div class="stat-label">ì°œí•œ ìƒí’ˆ</div>
                <div class="stat-description">ê´€ì‹¬ìˆëŠ” ìƒí’ˆ ëª¨ìŒ</div>
                <a href="/mypage/wishlist" class="stat-action" style="--card-color: #ff6b6b">ë³´ê¸°</a>
            </div>

            <!-- Store Wishlist -->
            <div class="stat-card wishlist" onclick="location.href='/mypage/liked-stores'">
                <div class="stat-number" th:text="${storeWishlistCount ?: 0}">0</div>
                <div class="stat-label">ê´€ì‹¬ ê°€ê²Œ</div>
                <div class="stat-description">ì°œí•œ ê°€ê²Œ ëª¨ìŒ</div>
                <a href="/mypage/liked-stores" class="stat-action" style="--card-color: #ff8e85">ë³´ê¸°</a>
            </div>

            <!-- Store Management -->
            <div class="stat-card store" 
                 sec:authorize="hasRole('ROLE_BUSINESS_OWNER') or hasRole('ROLE_ADMIN')"
                 th:onclick="'location.href=\'' + (${userStore != null} ? '/mypage/store' : '/stores/register') + '\''">
                <div class="stat-number" th:text="${userStore != null} ? 'âœ“' : 'âœ—'">âœ—</div>
                <div class="stat-label">ìŠ¤í† ì–´ ê´€ë¦¬</div>
                <div class="stat-description" th:text="${userStore != null} ? 'ìŠ¤í† ì–´ ìš´ì˜ ë° ê´€ë¦¬' : 'ìŠ¤í† ì–´ë¥¼ ë“±ë¡í•´ë³´ì„¸ìš”'">ìŠ¤í† ì–´ ìƒíƒœ</div>
                <a th:href="${userStore != null} ? '/mypage/store' : '/stores/register'" 
                   class="stat-action" 
                   style="--card-color: #ffecd2"
                   th:text="${userStore != null} ? 'ê´€ë¦¬í•˜ê¸°' : 'ë“±ë¡í•˜ê¸°'">ë“±ë¡í•˜ê¸°</a>
            </div>

            <!-- Store Management Placeholder for Non-Business Users -->
            <div class="stat-card store" 
                 sec:authorize="hasRole('ROLE_USER') and !hasRole('ROLE_BUSINESS_OWNER')"
                 onclick="alert('ì‚¬ì—…ì ë“±ê¸‰ìœ¼ë¡œ ì—…ê·¸ë ˆì´ë“œí•˜ì—¬ ìŠ¤í† ì–´ë¥¼ ê´€ë¦¬í•˜ì„¸ìš”!')">
                <div class="stat-number">ğŸ”’</div>
                <div class="stat-label">ìŠ¤í† ì–´ ê´€ë¦¬</div>
                <div class="stat-description">ì‚¬ì—…ì ë“±ê¸‰ í•„ìš”</div>
                <a href="/upgrade" class="stat-action" style="--card-color: #ffecd2">ì—…ê·¸ë ˆì´ë“œ</a>
            </div>
        </div>

        <!-- Quick Actions -->
        <div class="quick-actions">
            <h3>ğŸš€ ë¹ ë¥¸ ì‘ì—…</h3>
            <div class="actions-grid">
                <a href="/products/create" class="action-btn">
                    <span class="action-icon">ğŸ“¦</span>
                    ìƒˆ ìƒí’ˆ ë“±ë¡
                </a>
                <a href="/collabo/suggest" class="action-btn secondary">
                    <span class="action-icon">ğŸ’¡</span>
                    ì½œë¼ë³´ ì œì•ˆ
                </a>
                <a href="/explore" class="action-btn success">
                    <span class="action-icon">ğŸ”</span>
                    ì½œë¼ë³´ ì°¾ê¸°
                </a>
                <a href="/mypage/wishlist" class="action-btn" style="background: linear-gradient(135deg, #ff6b6b 0%, #ff8e85 100%);">
                    <span class="action-icon">â¤ï¸</span>
                    ì°œí•œ ìƒí’ˆ
                </a>
                <a href="/mypage/liked-stores" class="action-btn" style="background: linear-gradient(135deg, #ff8e85 0%, #ffa07a 100%);">
                    <span class="action-icon">ğŸª</span>
                    ê´€ì‹¬ ê°€ê²Œ
                </a>
                <a href="/chat/rooms" class="action-btn warning">
                    <span class="action-icon">ğŸ’¬</span>
                    ì±„íŒ…ë°© ê´€ë¦¬
                </a>
            </div>
        </div>

        <!-- Recent Activity -->
        <div class="recent-activity">
            <h3>ğŸ“ˆ ìµœê·¼ í™œë™</h3>
            
            <!-- Pending Applications -->
            <div th:each="pendingApp : ${#lists.size(pendingApplications) > 3 ? #lists.subList(pendingApplications, 0, 3) : pendingApplications}" class="activity-item">
                <div class="activity-icon pending">â³</div>
                <div class="activity-content">
                    <div class="activity-title" th:text="'ì½œë¼ë³´ ì‹ ì²­: ' + ${pendingApp.partnerProduct != null ? pendingApp.partnerProduct.name : (pendingApp.initiatorProduct != null ? pendingApp.initiatorProduct.name : 'ìƒí’ˆëª… ì—†ìŒ')}">ì½œë¼ë³´ ì‹ ì²­</div>
                    <div class="activity-description">ëŒ€ê¸° ì¤‘ì¸ ì‹ ì²­</div>
                </div>
                <div class="activity-time" th:text="${#temporals.format(pendingApp.createdAt, 'MM-dd')}">ë‚ ì§œ</div>
            </div>

            <!-- Ongoing Collaborations -->
            <div th:each="collaboration : ${#lists.size(ongoingCollaborations) > 2 ? #lists.subList(ongoingCollaborations, 0, 2) : ongoingCollaborations}" class="activity-item">
                <div class="activity-icon accepted">ğŸ¤</div>
                <div class="activity-content">
                    <div class="activity-title" th:text="'ì§„í–‰ì¤‘: ' + ${collaboration.partnerProduct != null ? collaboration.partnerProduct.name : (collaboration.initiatorProduct != null ? collaboration.initiatorProduct.name : 'ìƒí’ˆëª… ì—†ìŒ')}">ì§„í–‰ì¤‘ ì½œë¼ë³´</div>
                    <div class="activity-description">í™œì„± ì½œë¼ë³´ë ˆì´ì…˜</div>
                </div>
                <div class="activity-time" th:text="${#temporals.format(collaboration.createdAt, 'MM-dd')}">ë‚ ì§œ</div>
            </div>

            <!-- Received Applications -->
            <div th:each="received : ${#lists.size(receivedApplications) > 2 ? #lists.subList(receivedApplications, 0, 2) : receivedApplications}" class="activity-item">
                <div class="activity-icon received">ğŸ“©</div>
                <div class="activity-content">
                    <div class="activity-title" th:text="'ì‹ ì²­ ë°›ìŒ: ' + ${received.partnerProduct.name}">ë°›ì€ ì‹ ì²­</div>
                    <div class="activity-description" th:text="${received.initiatorStore != null ? received.initiatorStore.user.username : 'Unknown'} + 'ë‹˜ì˜ ì‹ ì²­'">ì‹ ì²­ì ì •ë³´</div>
                </div>
                <div class="activity-time" th:text="${#temporals.format(received.createdAt, 'MM-dd')}">ë‚ ì§œ</div>
            </div>

            <!-- Empty State -->
            <div th:if="${#lists.isEmpty(pendingApplications) && #lists.isEmpty(ongoingCollaborations) && #lists.isEmpty(receivedApplications)}" 
                 style="text-align: center; padding: 40px; color: #666;">
                <div style="font-size: 3rem; margin-bottom: 15px;">ğŸŒŸ</div>
                <h4>ì•„ì§ í™œë™ì´ ì—†ìŠµë‹ˆë‹¤</h4>
                <p>ì²« ë²ˆì§¸ ì½œë¼ë³´ë¥¼ ì‹œì‘í•´ë³´ì„¸ìš”!</p>
            </div>
        </div>
    </div>

    <script>
        // Add click handlers for stat cards
        document.querySelectorAll('.stat-card').forEach(card => {
            card.addEventListener('click', function(e) {
                // Prevent navigation if clicking on the action button
                if (!e.target.closest('.stat-action')) {
                    const link = this.querySelector('.stat-action');
                    if (link) {
                        window.location.href = link.href;
                    }
                }
            });
        });

        // Auto-refresh for real-time updates (every 30 seconds)
        setTimeout(() => {
            location.reload();
        }, 30000);
    </script>
    
    <script th:src="@{/js/sidebar.js}"></script>
</body>
</html>