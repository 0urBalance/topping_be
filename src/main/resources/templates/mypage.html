<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Page - Topping</title>
    
    <!-- Google Tag Manager -->
    <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
    new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
    j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
    'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
    })(window,document,'script','dataLayer','GTM-T5T3CSLT');</script>
    <!-- End Google Tag Manager -->

    <!-- Google tag (gtag.js) -->
    <script async src='https://www.googletagmanager.com/gtag/js?id=G-Y1ZSWHSQD0'></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-Y1ZSWHSQD0');
    </script>
    <link rel="stylesheet" th:href="@{/css/navbar.css}">
    <link rel="stylesheet" th:href="@{/css/base.css}">
    <link
            rel="stylesheet"
            href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200"
    />
    <style>
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            margin: 0; 
            margin-left: 160px; /* Account for sidebar */
            padding: 0;
            background: #f8f9fa; 
            min-height: 100vh; 
            transition: margin-left 0.3s ease;
        }
        
        @media (max-width: 768px) {
            body {
                margin-left: 0; /* No sidebar offset on mobile */
            }
        }
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; }
        .header h1 { font-size: 2rem; margin: 0; color: #333; font-weight: 700; }
        .edit-profile-btn { background: #f8f9fa; border: 1px solid #ddd; padding: 8px 16px; border-radius: 8px; text-decoration: none; color: #666; font-size: 0.9rem; display: flex; align-items: center; gap: 5px; }
        .edit-profile-btn:hover { background: #e9ecef; }
        .user-profile { display: flex; align-items: center; gap: 15px; margin-bottom: 30px; }
        .user-avatar { width: 60px; height: 60px; border-radius: 50%; background: #87604F; display: flex; align-items: center; justify-content: center; color: white; font-size: 1.5rem; font-weight: bold; }
        .user-info h2 { margin: 0 0 5px 0; font-size: 1.5rem; color: #333; }
        .user-info p { margin: 0; color: #666; font-size: 0.9rem; }

        /* Alert Banner for Pending Actions */
        .alert-banner { background: linear-gradient(135deg, #ff6b6b 0%, #ff8e53 100%); color: white; padding: 15px 20px; border-radius: 10px; margin-bottom: 30px; display: flex; align-items: center; justify-content: space-between; box-shadow: 0 4px 15px rgba(255,107,107,0.3); }
        .alert-banner.hidden { display: none; }
        .alert-content { display: flex; align-items: center; }
        .alert-icon { font-size: 1.5rem; margin-right: 15px; }
        .alert-text h4 { margin: 0; font-size: 1.1rem; }
        .alert-text p { margin: 5px 0 0 0; font-size: 0.9rem; opacity: 0.9; }
        .alert-action { background: rgba(255,255,255,0.2); padding: 8px 16px; border-radius: 5px; text-decoration: none; color: white; font-weight: 600; transition: all 0.3s; }
        .alert-action:hover { background: rgba(255,255,255,0.3); transform: translateY(-1px); }

        /* Stats Grid */
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); gap: 20px; margin-bottom: 40px; max-width: 1000px; }
        .stat-card { background: white; border-radius: 15px; padding: 0; box-shadow: 0 2px 10px rgba(0,0,0,0.1); text-align: center; transition: all 0.3s; cursor: pointer; position: relative; border: 1px solid #f0f0f0; display: flex; flex-direction: column; min-height: 200px; }
        .stat-card:hover { transform: translateY(-3px); box-shadow: 0 8px 25px rgba(0,0,0,0.15); }
        .stat-card.has-alert::before { content: ''; position: absolute; top: 10px; right: 10px; width: 8px; height: 8px; background: #ff4757; border-radius: 50%; z-index: 1; }
        
        .stat-content { padding: 30px 30px 20px 30px; flex: 1; display: flex; flex-direction: column; }
        .stat-number { font-size: 2.5rem; font-weight: 700; color: #333; margin-bottom: 10px; }
        .stat-label { color: #333; font-size: 1.1rem; font-weight: 600; margin-bottom: 5px; }
        .stat-description { font-size: 0.85rem; color: #666; line-height: 1.4; margin-bottom: 0; flex: 1; }
        .stat-action { display: block; padding: 15px 20px; background: #87604F; color: white; text-decoration: none; border-radius: 0 0 15px 15px; font-size: 0.9rem; font-weight: 600; transition: all 0.3s; margin-top: auto; }
        .stat-action:hover { background: #6f4f41; }

        /* Collaboration Section */
        .collaboration-section { background: white; border-radius: 15px; padding: 30px; margin-bottom: 40px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); border: 1px solid #f0f0f0; }
        .section-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .section-header h3 { margin: 0; font-size: 1.3rem; color: #333; font-weight: 600; }
        .more-link { color: #666; text-decoration: none; font-size: 0.9rem; }
        .more-link:hover { color: #87604F; }
        .collaboration-actions { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; }
        .action-btn-new { display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 20px; background: #f8f9fa; border: 1px solid #e9ecef; text-decoration: none; border-radius: 10px; transition: all 0.3s; color: #666; text-align: center; }
        .action-btn-new:hover { background: #e9ecef; transform: translateY(-2px); }
        .action-btn-new .material-symbols-outlined { font-size: 2rem; margin-bottom: 8px; }
        .action-btn-new { font-size: 0.9rem; font-weight: 500; }

        /* Recent Activity Section */
        .recent-activity { background: white; border-radius: 15px; padding: 30px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); border: 1px solid #f0f0f0; }
        .recent-activity .section-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .recent-activity h3 { margin: 0; font-size: 1.3rem; color: #333; font-weight: 600; }
        .empty-state { text-align: center; padding: 60px 20px; }
        .empty-state .empty-icon { width: 80px; height: 80px; margin: 0 auto 20px; background: #f8f9fa; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 2rem; }
        .empty-state h4 { margin: 0 0 10px 0; color: #333; font-size: 1.1rem; }
        .empty-state p { margin: 0; color: #666; font-size: 0.9rem; }
        .activity-item { display: flex; align-items: center; padding: 15px 0; border-bottom: 1px solid #f0f0f0; }
        .activity-item:last-child { border-bottom: none; }
        .activity-icon { width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-right: 15px; font-size: 1.1rem; color: white; }
        .activity-icon.pending { background: #ffc107; }
        .activity-icon.accepted { background: #28a745; }
        .activity-icon.received { background: #17a2b8; }
        .activity-content { flex: 1; }
        .activity-title { font-weight: 600; color: #333; margin-bottom: 3px; }
        .activity-description { font-size: 0.9rem; color: #666; }
        .activity-time { font-size: 0.8rem; color: #999; margin-left: auto; }

        /* Responsive Design */
        @media (max-width: 768px) {
            .container { padding: 15px; }
            .header { flex-direction: column; align-items: flex-start; gap: 15px; }
            .header h1 { font-size: 1.8rem; }
            .user-profile { flex-direction: column; text-align: center; }
            .user-avatar { margin: 0 auto; }
            .stats-grid { grid-template-columns: 1fr; gap: 15px; }
            .collaboration-actions { grid-template-columns: repeat(2, 1fr); }
        }
    </style>
</head>
<body>
    <!-- Google Tag Manager (noscript) -->
    <noscript><iframe src='https://www.googletagmanager.com/ns.html?id=GTM-T5T3CSLT'
    height='0' width='0' style='display:none;visibility:hidden'></iframe></noscript>
    <!-- End Google Tag Manager (noscript) -->
    
    <div th:replace="fragments/navbar :: navbar"></div>
    
    <div class="container">
        <!-- Header Section -->
        <div class="header">
            <h1>ë§ˆì´í˜ì´ì§€</h1>
            <a href="/users/edit" class="edit-profile-btn">
                <span class="material-symbols-outlined">edit</span>
                ë‚´ ì •ë³´ ìˆ˜ì •í•˜ê¸°
            </a>
        </div>
        
        <!-- User Profile Section -->
        <div class="user-profile">
            <div class="user-avatar" th:text="${#strings.substring(user.username, 0, 1)}">ê¹€</div>
            <div class="user-info">
                <h2>ì•ˆë…•í•˜ì„¸ìš”, <span th:text="${user.username}">ê¹€ìš°ì •</span> ë‹˜!</h2>
                <p>ì˜¤ëŠ˜ë„ ì„±ê³µì ì¸ ì½œë¼ë³´ë ˆì´ì…˜ì„ ìœ„í•´ í•¨ê»˜í•´ìš”!</p>
            </div>
        </div>

        <!-- Access Denied Error Message -->
        <div class="alert-banner" th:if="${param.error != null and param.error[0] == 'access_denied'}">
            <div class="alert-content">
                <div class="alert-icon">ğŸš«</div>
                <div class="alert-text">
                    <h4>ì ‘ê·¼ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤</h4>
                    <p>ìŠ¤í† ì–´ ê´€ë¦¬ ê¸°ëŠ¥ì€ ì‚¬ì—…ì íšŒì›ë§Œ ì´ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤</p>
                </div>
            </div>
            <a href="/upgrade" class="alert-action">ì‚¬ì—…ì ë“±ê¸‰ ì—…ê·¸ë ˆì´ë“œ</a>
        </div>

        <!-- Upgrade Required Info Message -->
        <div class="alert-banner" th:if="${param.info != null and param.info[0] == 'upgrade_required'}" style="background: linear-gradient(135deg, #87604F 0%, #6f4f41 100%);">
            <div class="alert-content">
                <div class="alert-icon">ğŸ’¼</div>
                <div class="alert-text">
                    <h4>ì‚¬ì—…ì ë“±ê¸‰ ì—…ê·¸ë ˆì´ë“œ ì•ˆë‚´</h4>
                    <p>ìŠ¤í† ì–´ ê´€ë¦¬ì™€ ê³ ê¸‰ ê¸°ëŠ¥ì„ ì´ìš©í•˜ë ¤ë©´ ì‚¬ì—…ì ë“±ê¸‰ìœ¼ë¡œ ì—…ê·¸ë ˆì´ë“œí•˜ì„¸ìš”</p>
                </div>
            </div>
            <a href="/contact" class="alert-action">ë¬¸ì˜í•˜ê¸°</a>
        </div>

        <!-- Alert Banner for Pending Actions -->
        <div class="alert-banner" th:classappend="${pendingActionsCount == 0} ? 'hidden' : ''">
            <div class="alert-content">
                <div class="alert-icon">ğŸ””</div>
                <div class="alert-text">
                    <h4>ì²˜ë¦¬ê°€ í•„ìš”í•œ ì‘ì—…ì´ ìˆìŠµë‹ˆë‹¤</h4>
                    <p th:text="${pendingActionsCount} + 'ê°œì˜ ì½œë¼ë³´ ì‹ ì²­ì´ ëŒ€ê¸° ì¤‘ì…ë‹ˆë‹¤'">ì•Œë¦¼ ë‚´ìš©</p>
                </div>
            </div>
            <a href="/mypage/received" class="alert-action">í™•ì¸í•˜ê¸°</a>
        </div>

        <!-- Statistics Grid -->
        <div class="stats-grid">
            <!-- My Applications -->
            <div class="stat-card applications" th:classappend="${pendingApplicationCount > 0} ? 'has-alert' : ''" onclick="location.href='/mypage/applications'">
                <div class="stat-content">
                    <div class="stat-number" th:text="${applicationCount ?: 0}">2</div>
                    <div class="stat-label">ë‚´ ì‹ ì²­</div>
                    <div class="stat-description">ë‚´ê°€ ì‹ ì²­í•œ ì½œë¼ë³´ í˜„í™©</div>
                </div>
                <a href="/mypage/applications" class="stat-action">ë³´ê¸°</a>
            </div>

            <!-- Ongoing Collaborations -->
            <div class="stat-card ongoing" onclick="location.href='/mypage/ongoing'">
                <div class="stat-content">
                    <div class="stat-number" th:text="${ongoingCollaborationCount ?: 0}">2</div>
                    <div class="stat-label">ì§„í–‰ì¤‘ ì½œë¼ë³´</div>
                    <div class="stat-description">í˜„ì¬ í™œì„± ìƒíƒœì¸ ì½œë¼ë³´</div>
                </div>
                <a href="/mypage/ongoing" class="stat-action">ê´€ë¦¬í•˜ê¸°</a>
            </div>

            <!-- My Products -->
            <div class="stat-card products" onclick="location.href='/mypage/product'">
                <div class="stat-content">
                    <div class="stat-number" th:text="${productCount ?: 0}">12</div>
                    <div class="stat-label">ë“±ë¡í•œ ìƒí’ˆ</div>
                    <div class="stat-description">ë‚´ê°€ ë“±ë¡í•œ ìƒí’ˆ ê´€ë¦¬</div>
                </div>
                <a href="/mypage/product" class="stat-action">ê´€ë¦¬í•˜ê¸°</a>
            </div>

            <!-- Received Applications -->
            <div class="stat-card received" th:classappend="${pendingActionsCount > 0} ? 'has-alert' : ''" onclick="location.href='/mypage/received'">
                <div class="stat-content">
                    <div class="stat-number" th:text="${receivedApplicationCount ?: 0}">2</div>
                    <div class="stat-label">ë°›ì€ ì œì•ˆì„œ</div>
                    <div class="stat-description">ë‚´ ìƒí’ˆì— ì˜¨ ì½œë¼ë³´ ì‹ ì²­</div>
                </div>
                <a href="/mypage/received" class="stat-action">ì²˜ë¦¬í•˜ê¸°</a>
            </div>

            <!-- Store Management -->
            <div class="stat-card store" 
                 sec:authorize="hasRole('ROLE_BUSINESS_OWNER') or hasRole('ROLE_ADMIN')"
                 th:onclick="'location.href=\'' + (${userStore != null} ? '/mypage/store' : '/stores/register') + '\''">
                <div class="stat-content">
                    <div class="stat-number" th:text="${userStore != null} ? '5' : '0'">5</div>
                    <div class="stat-label">ìŠ¤í† ì–´ ê´€ë¦¬</div>
                    <div class="stat-description">í† í•‘íŒŒíŠ¸ë„ˆ</div>
                </div>
                <a th:href="${userStore != null} ? '/mypage/store' : '/stores/register'" 
                   class="stat-action" 
                   th:text="${userStore != null} ? 'ê´€ë¦¬í•˜ê¸°' : 'ë“±ë¡í•˜ê¸°'">ê´€ë¦¬í•˜ê¸°</a>
            </div>

            <!-- Wishlist Combined -->
            <div class="stat-card wishlist" onclick="location.href='/mypage/wishlist'">
                <div class="stat-content">
                    <div class="stat-number" th:text="${wishlistCount + storeWishlistCount ?: 0}">24</div>
                    <div class="stat-label">ì°œí•œ ëª©ë¡</div>
                    <div class="stat-description">ì½œë¼ë³´ ê°€ì¹˜ ì»¸ë˜ ëª©ë¡</div>
                </div>
                <a href="/mypage/wishlist" class="stat-action">ë³´ê¸°</a>
            </div>

            <!-- Store Management Placeholder for Non-Business Users -->
            <div class="stat-card store" 
                 sec:authorize="hasRole('ROLE_USER') and !hasRole('ROLE_BUSINESS_OWNER')"
                 onclick="alert('ì‚¬ì—…ì ë“±ê¸‰ìœ¼ë¡œ ì—…ê·¸ë ˆì´ë“œí•˜ì—¬ ìŠ¤í† ì–´ë¥¼ ê´€ë¦¬í•˜ì„¸ìš”!')">
                <div class="stat-content">
                    <div class="stat-number">0</div>
                    <div class="stat-label">ìŠ¤í† ì–´ ê´€ë¦¬</div>
                    <div class="stat-description">ì‚¬ì—…ì ë“±ê¸‰ í•„ìš”</div>
                </div>
                <a href="/upgrade" class="stat-action">ì—…ê·¸ë ˆì´ë“œ</a>
            </div>
        </div>

        <!-- My Collaboration Section -->
        <div class="collaboration-section">
            <div class="section-header">
                <h3>ë‚˜ì˜ ì½œë¼ë³´ ì œì•ˆ</h3>
                <a href="/mypage/collabos" class="more-link">ë” ë³´ê¸° ></a>
            </div>
            <div class="collaboration-actions">
                <a href="/products/create" class="action-btn-new">
                    <span class="material-symbols-outlined">add_circle</span>
                    ìƒˆ ìƒí’ˆ ë“±ë¡
                </a>
                <a href="/collabo/suggest" class="action-btn-new">
                    <span class="material-symbols-outlined">search</span>
                    ì½œë¼ë³´ ì°¾ê¸°
                </a>
                <a href="/mypage/wishlist" class="action-btn-new">
                    <span class="material-symbols-outlined">bookmark</span>
                    ì½œë¼ë³´ ì €ì¥
                </a>
                <a href="/chat/rooms" class="action-btn-new">
                    <span class="material-symbols-outlined">support_agent</span>
                    ì±„íŒ… ê´€ë¦¬
                </a>
            </div>
        </div>

        <!-- Recent Activity -->
        <div class="recent-activity">
            <div class="section-header">
                <h3>ìµœê·¼ í™œë™</h3>
                <a href="/mypage/applications" class="more-link">ë” ë³´ê¸° ></a>
            </div>
            
            <!-- Empty State -->
            <div th:if="${#lists.isEmpty(pendingApplications) && #lists.isEmpty(ongoingCollaborations) && #lists.isEmpty(receivedApplications)}" 
                 class="empty-state">
                <div class="empty-icon">
                    <span class="material-symbols-outlined">pace</span>
                </div>
                <h4>ì•„ì§ í™œë™ì´ ì—†ìŠµë‹ˆë‹¤.</h4>
                <p>ì²« ë²ˆì§¸ ì½œë¼ë³´ë¥¼ ì‹œì‘í•´ë³´ì„¸ìš”!</p>
            </div>
            
            <!-- Pending Applications -->
            <div th:each="pendingApp : ${#lists.size(pendingApplications) > 3 ? #lists.subList(pendingApplications, 0, 3) : pendingApplications}" class="activity-item">
                <div class="activity-icon pending">â³</div>
                <div class="activity-content">
                    <div class="activity-title" th:text="'ì½œë¼ë³´ ì‹ ì²­: ' + ${pendingApp.partnerProduct != null ? pendingApp.partnerProduct.name : (pendingApp.initiatorProduct != null ? pendingApp.initiatorProduct.name : 'ìƒí’ˆëª… ì—†ìŒ')}">ì½œë¼ë³´ ì‹ ì²­</div>
                    <div class="activity-description">ëŒ€ê¸° ì¤‘ì¸ ì‹ ì²­</div>
                </div>
                <div class="activity-time" th:text="${#temporals.format(pendingApp.createdAt, 'MM-dd')}">ë‚ ì§œ</div>
            </div>

            <!-- Ongoing Collaborations -->
            <div th:each="collaboration : ${#lists.size(ongoingCollaborations) > 2 ? #lists.subList(ongoingCollaborations, 0, 2) : ongoingCollaborations}" class="activity-item">
                <div class="activity-icon accepted">ğŸ¤</div>
                <div class="activity-content">
                    <div class="activity-title" th:text="'ì§„í–‰ì¤‘: ' + ${collaboration.partnerProduct != null ? collaboration.partnerProduct.name : (collaboration.initiatorProduct != null ? collaboration.initiatorProduct.name : 'ìƒí’ˆëª… ì—†ìŒ')}">ì§„í–‰ì¤‘ ì½œë¼ë³´</div>
                    <div class="activity-description">í™œì„± ì½œë¼ë³´ë ˆì´ì…˜</div>
                </div>
                <div class="activity-time" th:text="${#temporals.format(collaboration.createdAt, 'MM-dd')}">ë‚ ì§œ</div>
            </div>

            <!-- Received Applications -->
            <div th:each="received : ${#lists.size(receivedApplications) > 2 ? #lists.subList(receivedApplications, 0, 2) : receivedApplications}" class="activity-item">
                <div class="activity-icon received">ğŸ“©</div>
                <div class="activity-content">
                    <div class="activity-title" th:text="'ì‹ ì²­ ë°›ìŒ: ' + ${received.partnerProduct.name}">ë°›ì€ ì‹ ì²­</div>
                    <div class="activity-description" th:text="${received.initiatorStore != null ? received.initiatorStore.user.username : 'Unknown'} + 'ë‹˜ì˜ ì‹ ì²­'">ì‹ ì²­ì ì •ë³´</div>
                </div>
                <div class="activity-time" th:text="${#temporals.format(received.createdAt, 'MM-dd')}">ë‚ ì§œ</div>
            </div>
        </div>
    </div>

    <script>
        // Add click handlers for stat cards
        document.querySelectorAll('.stat-card').forEach(card => {
            card.addEventListener('click', function(e) {
                // Prevent navigation if clicking on the action button
                if (!e.target.closest('.stat-action')) {
                    const link = this.querySelector('.stat-action');
                    if (link) {
                        window.location.href = link.href;
                    }
                }
            });
        });

        // Add click handlers for new action buttons
        document.querySelectorAll('.action-btn-new').forEach(btn => {
            btn.addEventListener('click', function(e) {
                e.preventDefault();
                window.location.href = this.href;
            });
        });

        // Auto-refresh for real-time updates (every 30 seconds)
        setTimeout(() => {
            location.reload();
        }, 30000);
    </script>
    
    <script th:src="@{/js/sidebar.js}"></script>
</body>
</html>