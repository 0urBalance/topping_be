<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Topping - í˜‘ì—… ë§¤ì¹­ í”Œë«í¼</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 0; padding: 20px; background-color: #f5f5f5; }
        .container { max-width: 1200px; margin: 0 auto; }
        .header { text-align: center; margin-bottom: 40px; }
        .header h1 { color: #333; margin-bottom: 10px; }
        .header p { color: #666; font-size: 18px; }
        .nav { text-align: center; margin-bottom: 40px; }
        .nav a { margin: 0 15px; text-decoration: none; color: #007bff; font-weight: bold; }
        .nav a:hover { text-decoration: underline; }
        .products-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; }
        .product-card { background: white; border-radius: 8px; padding: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .product-card h3 { margin-top: 0; color: #333; }
        .product-card p { color: #666; margin: 10px 0; }
        .product-category { background: #e9ecef; padding: 4px 8px; border-radius: 4px; font-size: 12px; color: #495057; }
        .btn { display: inline-block; padding: 10px 20px; background: #007bff; color: white; text-decoration: none; border-radius: 4px; }
        .btn:hover { background: #0056b3; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ• Topping</h1>
            <p>Collaboë¥¼ ì°¾ê³  íŒŒíŠ¸ë„ˆë¥¼ ë§¤ì¹­í•˜ëŠ” í”Œë«í¼</p>
        </div>
        
        <div class="nav">
            <a href="/explore">Explore (íƒìƒ‰)</a>
            <a href="/collabo" id="collaboLink">Collabo (ì½œë¼ë³´)</a>
            <a href="/mypage" id="mypageLink" style="display: none;">My Page (ë§ˆì´í˜ì´ì§€)</a>
            <a href="/auth/login" id="loginLink">Login (ë¡œê·¸ì¸)</a>
            <a href="/auth/signup" id="signupLink">Sign Up (íšŒì›ê°€ì…)</a>
            <a href="#" id="logoutLink" style="display: none;" onclick="logout()">Logout (ë¡œê·¸ì•„ì›ƒ)</a>
        </div>

        <h2>ìµœê·¼ ë“±ë¡ëœ Collabo</h2>
        <div class="products-grid">
            <div th:each="product : ${recentProducts}" class="product-card">
                <h3 th:text="${product.title}">Collabo ì œëª©</h3>
                <p th:text="${product.description}">Collabo ì„¤ëª…</p>
                <span class="product-category" th:text="${product.category}">ì¹´í…Œê³ ë¦¬</span>
                <p><strong>ì‘ì„±ì:</strong> <span th:text="${product.creator.username}">ì‚¬ìš©ìëª…</span></p>
                <div style="margin-top: 15px;">
                    <a th:href="@{/products/{id}(id=${product.uuid})}" class="btn">ìì„¸íˆ ë³´ê¸°</a>
                    <a th:href="@{/collabo/apply/{id}(id=${product.uuid})}" class="btn" style="background: #28a745;">Collabo ì‹ ì²­</a>
                </div>
            </div>
        </div>
        
        <div th:if="${#lists.isEmpty(recentProducts)}" style="text-align: center; padding: 40px;">
            <p>ë“±ë¡ëœ Collaboê°€ ì—†ìŠµë‹ˆë‹¤.</p>
            <a href="/collabo/create" class="btn">ì²« Collabo ë“±ë¡í•˜ê¸°</a>
        </div>
    </div>

    <script>
        // Check authentication state on page load
        document.addEventListener('DOMContentLoaded', function() {
            updateNavigation();
        });

        function updateNavigation() {
            const accessToken = localStorage.getItem('accessToken');
            const isAuthenticated = accessToken !== null;
            
            // Get navigation elements
            const collaboLink = document.getElementById('collaboLink');
            const mypageLink = document.getElementById('mypageLink');
            const loginLink = document.getElementById('loginLink');
            const signupLink = document.getElementById('signupLink');
            const logoutLink = document.getElementById('logoutLink');
            
            if (isAuthenticated) {
                // Show authenticated user navigation
                if (mypageLink) mypageLink.style.display = 'inline';
                if (logoutLink) logoutLink.style.display = 'inline';
                if (loginLink) loginLink.style.display = 'none';
                if (signupLink) signupLink.style.display = 'none';
                
                // Add click handler for protected routes
                if (collaboLink) {
                    collaboLink.onclick = function(e) {
                        if (!localStorage.getItem('accessToken')) {
                            e.preventDefault();
                            alert('ë¡œê·¸ì¸ì´ í•„ìš”í•œ ì„œë¹„ìŠ¤ì…ë‹ˆë‹¤.');
                            window.location.href = '/auth/login';
                        }
                    };
                }
            } else {
                // Show guest navigation
                if (mypageLink) mypageLink.style.display = 'none';
                if (logoutLink) logoutLink.style.display = 'none';
                if (loginLink) loginLink.style.display = 'inline';
                if (signupLink) signupLink.style.display = 'inline';
                
                // Add click handler for protected routes
                if (collaboLink) {
                    collaboLink.onclick = function(e) {
                        e.preventDefault();
                        alert('ë¡œê·¸ì¸ì´ í•„ìš”í•œ ì„œë¹„ìŠ¤ì…ë‹ˆë‹¤.');
                        window.location.href = '/auth/login';
                    };
                }
            }
        }

        async function logout() {
            try {
                const accessToken = localStorage.getItem('accessToken');
                
                if (accessToken) {
                    // Call logout API
                    await fetch('/api/member/logout', {
                        method: 'POST',
                        headers: {
                            'Authorization': 'Bearer ' + accessToken,
                            'Content-Type': 'application/json'
                        }
                    });
                }
                
                // Clear local storage
                localStorage.removeItem('accessToken');
                localStorage.removeItem('userEmail');
                
                // Update navigation
                updateNavigation();
                
                // Show success message
                alert('ë¡œê·¸ì•„ì›ƒë˜ì—ˆìŠµë‹ˆë‹¤.');
                
                // Redirect to home
                window.location.href = '/';
                
            } catch (error) {
                console.error('Logout error:', error);
                // Clear storage anyway
                localStorage.removeItem('accessToken');
                localStorage.removeItem('userEmail');
                updateNavigation();
                window.location.href = '/';
            }
        }

        // Protect Collabo application links
        document.addEventListener('click', function(e) {
            if (e.target.href && e.target.href.includes('/collabo/apply/')) {
                if (!localStorage.getItem('accessToken')) {
                    e.preventDefault();
                    alert('ë¡œê·¸ì¸ì´ í•„ìš”í•œ ì„œë¹„ìŠ¤ì…ë‹ˆë‹¤.');
                    window.location.href = '/auth/login';
                }
            }
        });
    </script>
</body>
</html>