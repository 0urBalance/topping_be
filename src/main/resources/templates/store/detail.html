<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title th:text="${store.name} + ' - 토핑'">가게 상세 - 토핑</title>
    
    <!-- Google Tag Manager -->
    <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
    new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
    j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
    'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
    })(window,document,'script','dataLayer','GTM-T5T3CSLT');</script>
    <!-- End Google Tag Manager -->

    <!-- Google tag (gtag.js) -->
    <script async src='https://www.googletagmanager.com/gtag/js?id=G-Y1ZSWHSQD0'></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-Y1ZSWHSQD0');
    </script>

    <!-- Optimized CSS Framework -->
    <link rel="stylesheet" th:href="@{/css/base.css}">
    <link rel="stylesheet" th:href="@{/css/navbar.css}">
    <link rel="stylesheet" th:href="@{/css/store-detail-refactored.css}">
    <link rel="stylesheet"
          href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200"/>
    <link rel="icon" type="image/x-icon" th:href="@{/favicon.ico}">

    <!-- Performance Optimizations -->
    <meta name="user-authenticated" th:content="${#authorization.expression('isAuthenticated()')}"/>
    <link rel="preload" th:href="@{/js/store-detail-optimized.js}" as="script">
    <link rel="preload" th:href="${store.mainImage != null ? store.mainImage.imagePath : '/image/topping_L.png'}"
          as="image">
</head>
<body class="store-detail-body" th:attr="data-authenticated=${#authorization.expression('isAuthenticated()')}">
<!-- Google Tag Manager (noscript) -->
<noscript><iframe src='https://www.googletagmanager.com/ns.html?id=GTM-T5T3CSLT'
height='0' width='0' style='display:none;visibility:hidden'></iframe></noscript>
<!-- End Google Tag Manager (noscript) -->

<a href="#main-content" class="skip-link">메인 콘텐츠로 건너뛰기</a>
<div th:replace="~{fragments/navbar :: navbar}"></div>

<main id="main-content" class="main-content">
    <div class="container">

        <!-- 1️⃣ Hero Section with Background Image -->
        <section class="hero-section"
                 th:style="'background-image: url(' + (${store.mainImage != null ? store.mainImage.imagePath : (store.mainImageUrl != null ? store.mainImageUrl : '/image/topping_L.png')}) + ');'">
            <div class="hero-overlay"></div>
            <div class="hero-content grid-2">
                <!-- Left Column: Store Information -->
                <div class="store-info flex-col">
                    <div th:replace="~{fragments/tag :: category(${store.category})}"></div>
                    <h1 class="heading-hero text-white" th:text="${store.name}">에펠루아 본점</h1>
                    <div class="rating-section flex-center" style="justify-content: flex-start;">
                        <span th:if="${reviewCount > 0}" class="rating">⭐ <span th:text="${rating}">5</span></span>
                        <span th:if="${reviewCount > 0}" class="text-white-80">(<span th:text="${reviewCount}">0</span>)</span>
                        <span th:if="${reviewCount == 0}" class="text-white-80">아직 리뷰가 없습니다</span>
                    </div>
                    <div class="flex-center text-white-90" style="justify-content: flex-start;">
                        <span class="material-symbols-outlined">location_on</span>
                        <span th:text="${store.address}">강릉시 창해로 361-77</span>
                    </div>
                    <div th:if="${!store.hashtags.empty}"
                         th:replace="~{fragments/tag :: hashtag-group(${store.hashtags})}"></div>
                    <div th:if="${store.hashtags.empty}" th:replace="~{fragments/tag :: default-hashtag}"></div>
                    <div class="social-stats hero-buttons-container">
                        <button class="btn-base btn-hero collab-product-count" title="이 가게와 콜라보된 상품 수">
                            <span class="material-symbols-outlined">handshake</span>
                            <span th:text="${collabProductCount}">0</span>
                        </button>
                        <button class="btn-base btn-hero wishlist-btn">
                            <span class="material-symbols-outlined">favorite</span>
                            <span th:text="${wishlistCount}">1,115</span>
                        </button>
                    </div>
                </div>

                <!-- Right Column: Large Image Display -->
                <div class="flex-center">
                    <img th:if="${store.mainImage != null}"
                         th:src="${store.mainImage.imagePath}"
                         th:alt="${store.name}"
                         class="image-hero gallery-trigger"
                         data-index="0"
                         loading="eager"
                         onerror="this.src='/image/topping_M_text.png'"/>
                    <img th:if="${store.mainImage == null and store.mainImageUrl != null}"
                         th:src="${store.mainImageUrl}"
                         th:alt="${store.name}"
                         class="image-hero gallery-trigger"
                         data-index="0"
                         loading="eager"
                         onerror="this.src='/image/topping_M_text.png'"/>
                    <img th:if="${store.mainImage == null and store.mainImageUrl == null}"
                         th:src="@{/image/topping_L.png}"
                         th:alt="${store.name}"
                         class="image-hero gallery-trigger"
                         data-index="0"
                         loading="eager"
                         onerror="this.src='/image/topping_M_text.png'"/>
                </div>
            </div>
        </section>

        <!-- 2️⃣ Main Content Layout with Two Columns -->
        <div class="main-layout-wrapper">
            <!-- Left Column: Main Content -->
            <div class="main-content-column">
                <!-- Gallery Section (가게 사진) -->
                <section class="section">
                    <h2 class="heading-lg text-dark">가게 사진</h2>
                    <p class="text-base text-medium" style="margin-bottom: 24px;">가게의 분위기를 확인할 수 있어요.</p>

                    <div th:if="${!store.images.empty}" class="gallery-scroll">
                        <div class="image-gallery gallery-trigger"
                             th:each="image, iterStat : ${store.images}"
                             th:attr="data-index=${iterStat.index}">
                            <img th:src="${image.imagePath}"
                                 th:alt="${image.imageType.displayName}"
                                 th:title="${image.imageType.displayName}"
                                 loading="lazy"
                                 onerror="this.src='/image/topping_M_text.png'"/>
                        </div>
                    </div>

                    <div th:if="${store.images.empty}" class="empty-state">
                        <p>아직 등록된 이미지가 없습니다.</p>
                    </div>
                </section>

                <!-- Menu Introduction Section -->
                <!--                <section class="section">-->
                <!--                    <h2 class="heading-lg text-dark">메뉴 소개</h2>-->
                <!--                    <p class="text-base text-medium" style="margin-bottom: 24px;">고객들이 사랑하는 메뉴를 만나보세요.</p>-->
                <!--                </section>-->

                <!-- Menu Section 1: 콜라보 인기 메뉴 -->
                <section class="section">
                    <h3 class="heading-md text-dark">콜라보 인기 상품</h3>

                    <div th:if="${!#lists.isEmpty(popularMenus)}" class="grid-3">
                        <th:block th:each="product : ${popularMenus}">
                            <div th:replace="~{fragments/product-card :: card(${product})}"></div>
                        </th:block>
                    </div>

                    <div th:if="${#lists.isEmpty(popularMenus)}" class="empty-state">
                        <p>아직 등록된 인기 상품이 없습니다.</p>
                    </div>
                </section>

                <!-- Menu Section 2: 시그니처 메뉴 -->
                <section class="section">
                    <h3 class="heading-md text-dark">시그니처 상품</h3>

                    <div th:if="${!#lists.isEmpty(signatureMenus)}" class="grid-3">
                        <th:block th:each="product : ${signatureMenus}">
                            <div th:replace="~{fragments/product-card :: card(${product})}"></div>
                        </th:block>
                    </div>

                    <div th:if="${#lists.isEmpty(signatureMenus)}" class="empty-state">
                        <p>아직 등록된 시그니처 상품이 없습니다.</p>
                    </div>
                </section>
            </div>

            <!-- Right Column: SNS & Collaboration Info -->
            <div class="sidebar-content-column">
                <!-- SNS & Collaboration Section -->
                <div class="store-social-collab-box">
                    <h3 class="sidebar-heading" th:text="|${store.name}과 콜라보하고 있는 가게 보기|">에펠루아 본점과 콜라보하고 있는 가게 보기</h3>

                    <!-- Collaboration Info -->
                    <div class="collab-info">
                        <div class="collab-badge">
                            <span class="material-symbols-outlined">handshake</span>
                            <span class="collab-text" th:text="${store.name}">에펠루아 본점</span>
                            <span class="material-symbols-outlined toggle-icon"
                                  th:if="${!#lists.isEmpty(collaboratingStores)}">expand_more</span>
                        </div>

                        <p class="collab-desc">
                            이런 브랜드의 콜라보를 하고 있습니다<br>
                            함께 할 수 있어서요!
                        </p>

                        <!-- Collapsible Collaboration List -->
                        <ul id="collab-list" class="collab-list" style="display: none;"
                            th:if="${!#lists.isEmpty(collaboratingStores)}">
                            <li th:each="partner : ${collaboratingStores}" class="collab-item">
                                <span th:text="${partner.name}">Partner Store Name</span>
                            </li>
                        </ul>

                        <div class="collab-tags">
                            <th:block th:if="${!store.hashtags.empty}">
                                <span th:each="hashtag : ${store.hashtags}"
                                      th:text="${hashtag}"
                                      class="collab-tag"></span>
                            </th:block>
                            <th:block th:if="${store.hashtags.empty}">
                                <span class="collab-tag">#아직</span>
                                <span class="collab-tag">#테그가</span>
                                <span class="collab-tag">#없습니다</span>
                            </th:block>
                        </div>
                    </div>

                    <!-- SNS Section -->
                    <div class="sns-section">
                        <a th:if="${store.snsOrWebsiteLink != null and !#strings.isEmpty(store.snsOrWebsiteLink)}"
                           th:href="${store.snsOrWebsiteLink}"
                           target="_blank"
                           class="sns-link">
                            <span class="material-symbols-outlined">camera_alt</span>
                            <span th:text="${store.snsOrWebsiteLink}">https://www.instagram.com/eiffelrua_gangneung</span>
                        </a>
                        <div th:if="${store.snsOrWebsiteLink == null or #strings.isEmpty(store.snsOrWebsiteLink)}"
                             class="sns-placeholder">
                            SNS 링크가 등록되지 않았습니다.
                        </div>
                    </div>

                    <!-- Collaboration Action Button -->
                    <button class="btn-base btn-primary collaboration-btn sns-collab-btn"
                            th:attr="data-store-id=${store.uuid}">
                        콜라보 요청하기
                    </button>
                </div>
            </div>
        </div>

    </div>
</main>

<!-- 4️⃣ Fixed Action Bar -->
<div class="action-bar">
    <div th:replace="~{fragments/navbar :: navbar}"></div>
    <div class="action-bar-content flex-between">
        <button class="btn-base btn-primary collaboration-btn"
                th:attr="data-store-id=${store.uuid}">
            콜라보 요청하기
        </button>
        <div class="action-buttons flex-center">
            <button class="btn-base btn-action wishlist-btn"
                    th:attr="data-store-id=${store.uuid}"
                    th:classappend="${isLiked} ? ' liked' : ''"
                    title="좋아요">
                <span class="material-symbols-outlined" th:text="${isLiked} ? 'favorite' : 'favorite_border'">favorite_border</span>
                <span class="like-count" th:text="${likeCount}">0</span>
            </button>
            <button class="btn-base btn-action share-btn" title="링크 공유">
                <span class="material-symbols-outlined">share</span>
            </button>
        </div>
    </div>
</div>

<div th:replace="~{fragments/footer :: footer}"></div>
<div th:replace="~{fragments/modals :: policy-modals}"></div>
<div th:replace="~{fragments/modals :: confirmation-modal}"></div>

<!-- Optimized Scripts -->
<script th:src="@{/js/common.js}" defer></script>
<script th:src="@{/js/store-detail-optimized.js}" defer></script>
</body>
</html>
