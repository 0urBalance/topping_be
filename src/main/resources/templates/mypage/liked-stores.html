<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>관심 가게 - Topping</title>
    
    <!-- Google Tag Manager -->
    <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
    new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
    j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
    'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
    })(window,document,'script','dataLayer','GTM-T5T3CSLT');</script>
    <!-- End Google Tag Manager -->

    <!-- Google tag (gtag.js) -->
    <script async src='https://www.googletagmanager.com/gtag/js?id=G-Y1ZSWHSQD0'></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-Y1ZSWHSQD0');
    </script>
    
    <link rel="stylesheet" th:href="@{/css/navbar.css}">
    <link rel="stylesheet" th:href="@{/css/base.css}">
    <link
            rel="stylesheet"
            href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200"
    />
    <style>
        body { font-family: Arial, sans-serif; margin: 0; padding: 0; background-color: #f5f5f5; }
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
        .header { text-align: center; margin-bottom: 40px; }
        .header h1 { color: #333; margin-bottom: 10px; }
        .header p { color: #666; font-size: 18px; }
        .breadcrumb { margin-bottom: 20px; }
        .breadcrumb a { color: #87604F; text-decoration: none; }
        .breadcrumb a:hover { text-decoration: underline; }
        .breadcrumb span { color: #666; }
        .content-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 20px; }
        .content-card { background: white; border-radius: 8px; padding: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); position: relative; }
        .content-card h4 { margin-top: 0; color: #333; }
        .content-card p { color: #666; margin: 10px 0; }
        .store-image { width: 100%; height: 200px; object-fit: cover; border-radius: 8px; margin-bottom: 15px; }
        .store-info { margin-bottom: 15px; }
        .store-meta { font-size: 14px; color: #666; margin-top: 10px; }
        .store-meta p { margin: 5px 0; }
        .store-actions { display: flex; gap: 10px; margin-top: 15px; }
        .btn { display: inline-block; padding: 8px 16px; background: #87604F; color: white; text-decoration: none; border-radius: 4px; font-size: 14px; transition: background 0.3s; border: none; cursor: pointer; }
        .btn:hover { background: #6f4f41; }
        .btn-outline { background: transparent; color: #87604F; border: 1px solid #87604F; }
        .btn-outline:hover { background: #87604F; color: white; }
        .empty-state { text-align: center; padding: 60px 20px; }
        .empty-state .material-symbols-outlined { font-size: 80px; color: #ccc; margin-bottom: 20px; }
        .empty-state h3 { color: #666; margin-bottom: 10px; }
        .empty-state p { color: #999; }
        .liked-badge { position: absolute; top: 15px; right: 15px; background: #ff6b6b; color: white; padding: 4px 8px; border-radius: 4px; font-size: 12px; font-weight: bold; }
        .category-tag { display: inline-block; background: #e3f2fd; color: #1976d2; padding: 4px 8px; border-radius: 12px; font-size: 12px; margin-bottom: 10px; }
    </style>
    <link rel="icon" type="image/x-icon" th:href="@{/favicon.ico}">
</head>
<body>

<!-- Google Tag Manager (noscript) -->
<noscript><iframe src='https://www.googletagmanager.com/ns.html?id=GTM-T5T3CSLT'
height='0' width='0' style='display:none;visibility:hidden'></iframe></noscript>
<!-- End Google Tag Manager (noscript) -->

<a href="#main-content" class="skip-link">메인 콘텐츠로 건너뛰기</a>
<div th:replace="~{fragments/navbar :: navbar}"></div>

<main id="main-content" class="main-content">
    <div class="container">
        <!-- Breadcrumb -->
        <nav class="breadcrumb">
            <a href="/mypage">마이페이지</a>
            <span> > </span>
            <span>관심 가게</span>
        </nav>

        <!-- Header -->
        <div class="header">
            <h1>관심 가게 📍</h1>
            <p th:text="|총 ${likedStoreCount}개의 관심 가게를 저장했습니다.|">총 0개의 관심 가게를 저장했습니다.</p>
        </div>

        <!-- Content -->
        <div th:if="${!userStoreWishlist.empty}" class="content-grid">
            <div th:each="wishlist : ${userStoreWishlist}" class="content-card">
                <div class="liked-badge">❤️ 관심</div>
                
                <!-- Store Image -->
                <img th:if="${wishlist.store.mainImage != null}"
                     th:src="${wishlist.store.mainImage.imagePath}"
                     th:alt="${wishlist.store.name}"
                     class="store-image"
                     onerror="this.src='/image/topping_M_text.png'"/>
                <img th:if="${wishlist.store.mainImage == null and wishlist.store.mainImageUrl != null}"
                     th:src="${wishlist.store.mainImageUrl}"
                     th:alt="${wishlist.store.name}"
                     class="store-image"
                     onerror="this.src='/image/topping_M_text.png'"/>
                <div th:if="${wishlist.store.mainImage == null and wishlist.store.mainImageUrl == null}"
                     class="store-image"
                     style="background-color: #f0f0f0; display: flex; align-items: center; justify-content: center; font-size: 2rem; color: #ccc;">
                    🏪
                </div>

                <div class="store-info">
                    <!-- Category -->
                    <div th:if="${wishlist.store.category != null}" class="category-tag" th:text="${wishlist.store.category.displayName}">카테고리</div>
                    
                    <!-- Store Name -->
                    <h4 th:text="${wishlist.store.name}">가게 이름</h4>
                    
                    <!-- Description -->
                    <p th:if="${wishlist.store.description != null and !#strings.isEmpty(wishlist.store.description)}" 
                       th:text="${#strings.abbreviate(wishlist.store.description, 100)}">가게 설명</p>
                    
                    <!-- Address -->
                    <p th:if="${wishlist.store.address != null}">
                        <span class="material-symbols-outlined" style="font-size: 16px; vertical-align: middle;">location_on</span>
                        <span th:text="${wishlist.store.address}">주소</span>
                    </p>
                    
                    <!-- Store Meta Information -->
                    <div class="store-meta">
                        <p th:if="${wishlist.store.businessHours != null}">
                            <strong>영업시간:</strong> <span th:text="${wishlist.store.businessHours}">09:00 - 18:00</span>
                        </p>
                        <p th:if="${wishlist.store.contactNumber != null}">
                            <strong>전화번호:</strong> <span th:text="${wishlist.store.contactNumber}">010-1234-5678</span>
                        </p>
                        <p>
                            <strong>관심 등록일:</strong> 
                            <span th:text="${#temporals.format(wishlist.createdAt, 'yyyy.MM.dd HH:mm')}">2024.01.01 10:00</span>
                        </p>
                    </div>
                </div>

                <!-- Action Buttons -->
                <div class="store-actions">
                    <a th:href="@{'/stores/' + ${wishlist.store.uuid}}" class="btn">가게 보기</a>
                    <button class="btn btn-outline remove-wishlist-btn" 
                            th:attr="data-store-uuid=${wishlist.store.uuid}">관심 해제</button>
                </div>
            </div>
        </div>

        <!-- Empty State -->
        <div th:if="${userStoreWishlist.empty}" class="empty-state">
            <div class="material-symbols-outlined">favorite_border</div>
            <h3>아직 관심 가게가 없어요</h3>
            <p>마음에 드는 가게를 발견하면 하트 버튼을 눌러 관심 가게로 등록해보세요!</p>
            <a href="/explore" class="btn" style="margin-top: 20px;">가게 둘러보기</a>
        </div>
    </div>
</main>

<!-- Footer -->
<div th:replace="~{fragments/footer :: footer}"></div>

<!-- Common Modals -->
<div th:replace="~{fragments/modals :: policy-modals}"></div>
<div th:replace="~{fragments/modals :: error-modal}"></div>

<!-- Common Scripts -->
<script th:src="@{/js/sidebar.js}"></script>
<script th:src="@{/js/common.js}"></script>

<script>
// Handle remove wishlist button clicks
document.addEventListener('DOMContentLoaded', function() {
    document.querySelectorAll('.remove-wishlist-btn').forEach(btn => {
        btn.addEventListener('click', async function(e) {
            e.preventDefault();
            
            const storeUuid = this.dataset.storeUuid;
            const button = this;
            
            // Confirm removal
            if (!confirm('이 가게를 관심 목록에서 제거하시겠습니까?')) {
                return;
            }
            
            // Set loading state
            button.disabled = true;
            const originalText = button.textContent;
            button.textContent = '처리중...';
            
            try {
                const response = await fetch(`/stores/api/${storeUuid}/wishlist/toggle`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                if (response.ok) {
                    const result = await response.json();
                    if (result.code === 200 && result.data.isWishlisted === false) {
                        // Remove the card from the page
                        const card = button.closest('.content-card');
                        card.style.opacity = '0.5';
                        card.style.transform = 'scale(0.95)';
                        
                        setTimeout(() => {
                            card.remove();
                            
                            // Update count in header
                            const countElement = document.querySelector('.header p');
                            const currentCount = parseInt(countElement.textContent.match(/\d+/)[0]);
                            const newCount = currentCount - 1;
                            countElement.textContent = `총 ${newCount}개의 관심 가게를 저장했습니다.`;
                            
                            // Show empty state if no stores left
                            if (newCount === 0) {
                                location.reload();
                            }
                        }, 300);
                        
                        if (window.Topping && window.Topping.notify) {
                            window.Topping.notify.success('관심 가게에서 제거되었습니다');
                        }
                    }
                } else if (response.status === 401) {
                    window.location.href = '/login';
                } else {
                    throw new Error('서버 오류가 발생했습니다');
                }
            } catch (error) {
                console.error('Error removing from wishlist:', error);
                button.disabled = false;
                button.textContent = originalText;
                
                if (window.Topping && window.Topping.showError) {
                    window.Topping.showError('관심 가게 제거 중 오류가 발생했습니다');
                } else {
                    alert('관심 가게 제거 중 오류가 발생했습니다');
                }
            }
        });
    });
});
</script>

</body>
</html>